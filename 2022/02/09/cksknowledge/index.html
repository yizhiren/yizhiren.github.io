<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"yizhi.ren","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="CKS知识总结简介CKS考试是kubernetes认证系列中中高级的一个证书，相比CKAD和CKA难度略大一些。 一方面虽然CKS跟CKA和CKAD有部分交集，比如k8s的基本使用，RBAC&#x2F;secret的使用，集群升级等知识点，另一方面又是基于CKA的基础之上，考试也要求先通过CKA。 第二个相对难考的地方在于CKA和CKAD的考点都在kubernetes官网可以找到，但是CKS的很多">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s安全知识即CKS考试知识点总结">
<meta property="og:url" content="https://yizhi.ren/2022/02/09/cksknowledge/index.html">
<meta property="og:site_name" content="一支人">
<meta property="og:description" content="CKS知识总结简介CKS考试是kubernetes认证系列中中高级的一个证书，相比CKAD和CKA难度略大一些。 一方面虽然CKS跟CKA和CKAD有部分交集，比如k8s的基本使用，RBAC&#x2F;secret的使用，集群升级等知识点，另一方面又是基于CKA的基础之上，考试也要求先通过CKA。 第二个相对难考的地方在于CKA和CKAD的考点都在kubernetes官网可以找到，但是CKS的很多">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yizhi.ren/linkimage/cksknowledge/kube-bench-k8s-pdf.png">
<meta property="og:image" content="https://yizhi.ren/linkimage/cksknowledge/rbac-link.png">
<meta property="og:image" content="https://yizhi.ren/linkimage/cksknowledge/rbac-authorization.png">
<meta property="og:image" content="https://yizhi.ren/linkimage/cksknowledge/opa.png">
<meta property="og:image" content="https://yizhi.ren/linkimage/cksknowledge/gatekeeper-v3.png">
<meta property="og:image" content="https://yizhi.ren/linkimage/cksknowledge/aggregation-api-auth-flow.png">
<meta property="og:image" content="https://yizhi.ren/linkimage/cksknowledge/high_low_container_runtime.png">
<meta property="og:image" content="https://yizhi.ren/linkimage/cksknowledge/falco_architecture.png">
<meta property="og:image" content="https://yizhi.ren/linkimage/cksknowledge/falco_rule_match.png">
<meta property="article:published_time" content="2022-02-09T09:34:46.000Z">
<meta property="article:modified_time" content="2022-02-09T09:34:46.000Z">
<meta property="article:author" content="yizhiren">
<meta property="article:tag" content="kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yizhi.ren/linkimage/cksknowledge/kube-bench-k8s-pdf.png">


<link rel="canonical" href="https://yizhi.ren/2022/02/09/cksknowledge/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://yizhi.ren/2022/02/09/cksknowledge/","path":"2022/02/09/cksknowledge/","title":"k8s安全知识即CKS考试知识点总结"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>k8s安全知识即CKS考试知识点总结 | 一支人</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-69495409-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-69495409-1","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?3aa0f62e48c3501c66bc10dbe7a49356"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">一支人</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">碎碎念</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a></li><li class="menu-item menu-item-commonweal"><a href="/404.html" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#CKS%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93"><span class="nav-number">1.</span> <span class="nav-text">CKS知识总结</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">1.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E9%9B%86%E7%BE%A4"><span class="nav-number">1.2.</span> <span class="nav-text">搭建集群</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-ingress"><span class="nav-number">1.3.</span> <span class="nav-text">安装 ingress</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85metrics-server"><span class="nav-number">1.4.</span> <span class="nav-text">安装metrics server</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%90%E8%A1%8Ckube-bench"><span class="nav-number">1.5.</span> <span class="nav-text">运行kube-bench</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E6%9D%83%E9%99%90"><span class="nav-number">1.5.1.</span> <span class="nav-text">设置权限</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#kubelet%E6%9D%83%E9%99%90"><span class="nav-number">1.5.1.1.</span> <span class="nav-text">kubelet权限</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cni%E6%9D%83%E9%99%90"><span class="nav-number">1.5.1.2.</span> <span class="nav-text">cni权限</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#etcd%E6%9D%83%E9%99%90"><span class="nav-number">1.5.1.3.</span> <span class="nav-text">etcd权限</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubelet%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0"><span class="nav-number">1.5.2.</span> <span class="nav-text">kubelet配置参数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#authentication"><span class="nav-number">1.5.2.1.</span> <span class="nav-text">authentication</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#protectKernelDefaults"><span class="nav-number">1.5.2.2.</span> <span class="nav-text">protectKernelDefaults</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#eventRecordQPS-eventBurst"><span class="nav-number">1.5.2.3.</span> <span class="nav-text">eventRecordQPS&#x2F;eventBurst</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#apiserver%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0"><span class="nav-number">1.5.3.</span> <span class="nav-text">apiserver配置参数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#anonymous-auth"><span class="nav-number">1.5.3.1.</span> <span class="nav-text">anonymous-auth</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#kubelet-certificate-authority"><span class="nav-number">1.5.3.2.</span> <span class="nav-text">kubelet-certificate-authority</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#admission-control-EventRateLimit"><span class="nav-number">1.5.3.3.</span> <span class="nav-text">admission-control EventRateLimit</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#admission-control-AlwaysPullImages"><span class="nav-number">1.5.3.4.</span> <span class="nav-text">admission-control AlwaysPullImages</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#admission-control-SecurityContextDeny"><span class="nav-number">1.5.3.5.</span> <span class="nav-text">admission-control SecurityContextDeny</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#admission-control-PodSecurityContext"><span class="nav-number">1.5.3.6.</span> <span class="nav-text">admission-control PodSecurityContext</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#insecure-port"><span class="nav-number">1.5.3.7.</span> <span class="nav-text">insecure port</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#profiling"><span class="nav-number">1.5.3.8.</span> <span class="nav-text">profiling</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#audit-policy-file"><span class="nav-number">1.5.3.9.</span> <span class="nav-text">audit-policy-file</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#encryption-provider-config"><span class="nav-number">1.5.3.10.</span> <span class="nav-text">encryption-provider-config</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tls-cipher-suites"><span class="nav-number">1.5.3.11.</span> <span class="nav-text">tls-cipher-suites</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#request-timeout"><span class="nav-number">1.5.3.12.</span> <span class="nav-text">request-timeout</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#controller-manager%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0"><span class="nav-number">1.5.4.</span> <span class="nav-text">controller manager配置参数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#terminated-pod-gc-threshold"><span class="nav-number">1.5.4.1.</span> <span class="nav-text">terminated-pod-gc-threshold</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#profiling-1"><span class="nav-number">1.5.4.2.</span> <span class="nav-text">profiling</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#scheduller%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0"><span class="nav-number">1.5.5.</span> <span class="nav-text">scheduller配置参数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#profiling-2"><span class="nav-number">1.5.5.1.</span> <span class="nav-text">profiling</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#automountServiceAccountToken"><span class="nav-number">1.6.</span> <span class="nav-text">automountServiceAccountToken</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#secret%E7%AE%A1%E7%90%86"><span class="nav-number">1.7.</span> <span class="nav-text">secret管理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#seccomp-default"><span class="nav-number">1.8.</span> <span class="nav-text">seccomp default</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#seccomp-localhost"><span class="nav-number">1.9.</span> <span class="nav-text">seccomp localhost</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#privileges-risk"><span class="nav-number">1.10.</span> <span class="nav-text">privileges risk</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#podsecuritypolicy"><span class="nav-number">1.11.</span> <span class="nav-text">podsecuritypolicy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CSR-approve"><span class="nav-number">1.12.</span> <span class="nav-text">CSR approve</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ingress-usage"><span class="nav-number">1.13.</span> <span class="nav-text">ingress usage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ingress-tls"><span class="nav-number">1.14.</span> <span class="nav-text">ingress tls</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dashboard"><span class="nav-number">1.15.</span> <span class="nav-text">dashboard</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#checksum"><span class="nav-number">1.16.</span> <span class="nav-text">checksum</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RBAC"><span class="nav-number">1.17.</span> <span class="nav-text">RBAC</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OPA-Open-Policy-Agent"><span class="nav-number">1.18.</span> <span class="nav-text">OPA(Open Policy Agent)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GateKeeper"><span class="nav-number">1.19.</span> <span class="nav-text">GateKeeper</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AppArmor"><span class="nav-number">1.20.</span> <span class="nav-text">AppArmor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IAM-Identity-and-Access-Management"><span class="nav-number">1.21.</span> <span class="nav-text">IAM(Identity and Access Management)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#aggregator-proxy-%E9%9B%86%E5%90%88%E5%B1%82"><span class="nav-number">1.21.1.</span> <span class="nav-text">aggregator proxy(集合层)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#runtime-class"><span class="nav-number">1.22.</span> <span class="nav-text">runtime class</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%A9%E5%B0%8F%E9%95%9C%E5%83%8F"><span class="nav-number">1.23.</span> <span class="nav-text">缩小镜像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pod%E4%BC%98%E9%9B%85%E7%BB%88%E6%AD%A2%E6%B5%81%E7%A8%8B"><span class="nav-number">1.24.</span> <span class="nav-text">pod优雅终止流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#log-place"><span class="nav-number">1.25.</span> <span class="nav-text">log place</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ImagePolicyWebhook"><span class="nav-number">1.26.</span> <span class="nav-text">ImagePolicyWebhook</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#immutable-pod-stateless-pod"><span class="nav-number">1.27.</span> <span class="nav-text">immutable pod &#x2F; stateless pod</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kubesec"><span class="nav-number">1.28.</span> <span class="nav-text">kubesec</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#trivy"><span class="nav-number">1.29.</span> <span class="nav-text">trivy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#anchore-syft"><span class="nav-number">1.30.</span> <span class="nav-text">anchore&#x2F;syft</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#anchore-grype"><span class="nav-number">1.31.</span> <span class="nav-text">anchore&#x2F;grype</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sysdig-falco"><span class="nav-number">1.32.</span> <span class="nav-text">sysdig&#x2F;falco</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sysdig"><span class="nav-number">1.33.</span> <span class="nav-text">sysdig</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gadget"><span class="nav-number">1.34.</span> <span class="nav-text">gadget</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#immutable-pod-stateless-pod-1"><span class="nav-number">1.35.</span> <span class="nav-text">immutable pod &#x2F; stateless pod</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hostPath-security-issue"><span class="nav-number">1.36.</span> <span class="nav-text">hostPath security issue</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.37.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">1.38.</span> <span class="nav-text">参考</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yizhiren"
      src="https://avatars0.githubusercontent.com/u/15405596">
  <p class="site-author-name" itemprop="name">yizhiren</p>
  <div class="site-description" itemprop="description">[&](){}</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">27</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yizhi.ren/2022/02/09/cksknowledge/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/15405596">
      <meta itemprop="name" content="yizhiren">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一支人">
      <meta itemprop="description" content="[&](){}">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="k8s安全知识即CKS考试知识点总结 | 一支人">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          k8s安全知识即CKS考试知识点总结
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-02-09 17:34:46" itemprop="dateCreated datePublished" datetime="2022-02-09T17:34:46+08:00">2022-02-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">架构</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="CKS知识总结"><a href="#CKS知识总结" class="headerlink" title="CKS知识总结"></a>CKS知识总结</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>CKS考试是kubernetes认证系列中中高级的一个证书，相比CKAD和CKA难度略大一些。</p>
<p>一方面虽然CKS跟CKA和CKAD有部分交集，比如k8s的基本使用，RBAC&#x2F;secret的使用，集群升级等知识点，另一方面又是基于CKA的基础之上，考试也要求先通过CKA。</p>
<p>第二个相对难考的地方在于CKA和CKAD的考点都在kubernetes官网可以找到，但是CKS的很多知识点跳到了外部，涉及到外部的工具，外部的插件等等。</p>
<p>第三个点是CKS的部分知识点需要自己做一定的探索，换句话说不操作一遍的话都不知道他是什么，他涉及到什么知识。</p>
<p>同时，CKAD、CKA、CKS相同的点是都有前人为我们列好了考试大纲，列好了知识点和链接：<a target="_blank" rel="noopener" href="https://github.com/walidshaari/Kubernetes-Certified-Administrator">CKA</a>&#x2F;<a target="_blank" rel="noopener" href="https://github.com/dgkanatsios/CKAD-exercises">CKAD</a>&#x2F;<a target="_blank" rel="noopener" href="https://github.com/walidshaari/Certified-Kubernetes-Security-Specialist">CKS</a></p>
<p>这里主要基于第3个难点，对涉及到的操作做一个细致的记录，方便大家参考，减少学习者的探索时间。</p>
<span id="more"></span>

<h2 id="搭建集群"><a href="#搭建集群" class="headerlink" title="搭建集群"></a>搭建集群</h2><p>由于操作性比较强，所以必然的需要一个可以操作和试验的集群，大家可以根据自己的喜好去搭建，可以去使用在线的云计算平台搭建，阿里云，腾讯云，gcloud等，也可以使用自己的机器去搭建，最少需要两个机器或者两个虚拟机。</p>
<p>我提供一个在树莓派上搭建k8s的详细步骤，参考<a href="https://yizhi.ren/2022/01/25/setupk8s/">树莓派搭建k8s集群</a>。</p>
<p>后面的步骤会基于树莓派上搭建的集群来操作，集群由一个master和一个worker组成。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~$</span><span class="bash"> kubectl get node</span></span><br><span class="line">NAME      STATUS     ROLES                  AGE     VERSION</span><br><span class="line">server1   Ready      control-plane,master   6d22h   v1.22.1</span><br><span class="line">server2   Ready      &lt;none&gt;                 2m3s    v1.22.1</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="安装-ingress"><a href="#安装-ingress" class="headerlink" title="安装 ingress"></a>安装 ingress</h2><p>ingress controller我们使用ingress-nginx. 在kuberetes官方github账户下存在两个ingress的repo，一个是<a target="_blank" rel="noopener" href="https://github.com/kubernetes/ingress-gce">ingress-gce</a>，一个是<a target="_blank" rel="noopener" href="https://github.com/kubernetes/ingress-nginx">ingress-nginx</a>，gce是给google cloud专用的，我们当然选择一个通用的ingress-nginx。</p>
<p>ingress-nginx的安装原本是简单的一行指令，但是ingress-nginx的image国内无法访问，需要自己在hub.docker.com搜索别人同步过来的包并替换。</p>
<p>所以安装ingress-nginx的步骤如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">拷贝这里的内容</span><br><span class="line">https://github.com/kubernetes/ingress-nginx/blob/main/deploy/static/provider/baremetal/deploy.yaml</span><br><span class="line"></span><br><span class="line">然后把里面</span><br><span class="line">k8s.gcr.io/ingress-nginx/controller:v1.1.0@sha256:f766669fdcf3dc26347ed273a55e754b427eb4411ee075a53f30718b4499076a</span><br><span class="line">替换成</span><br><span class="line">cangyin/ingress-nginx-controller:v1.1.0</span><br><span class="line"></span><br><span class="line">把里面的</span><br><span class="line">k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660</span><br><span class="line">替换成</span><br><span class="line">liangjw/kube-webhook-certgen:v1.1.1</span><br><span class="line"></span><br><span class="line">最后kubect apply -f deploy.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当然网络没问题的情况下就直接:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/kubernetes/ingress-nginx/blob/main/deploy/static/provider/baremetal/deploy.yaml</span><br></pre></td></tr></table></figure>

<p>成功后：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~$</span><span class="bash"> kl get svc -n ingress-nginx</span></span><br><span class="line">NAME                                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">ingress-nginx-controller             NodePort    10.20.148.137   &lt;none&gt;        80:31724/TCP,443:31447/TCP   20m</span><br><span class="line">ingress-nginx-controller-admission   ClusterIP   10.20.160.241   &lt;none&gt;        443/TCP                      20m</span><br></pre></td></tr></table></figure>



<h2 id="安装metrics-server"><a href="#安装metrics-server" class="headerlink" title="安装metrics server"></a>安装metrics server</h2><p>同样，网络不通的情况下metrics server安装时镜像也需要换成hub.docker.com下的包。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</span><br><span class="line">然后编辑components.yaml，在args中添加--kubelet-insecure-tls参数</span><br><span class="line"><span class="meta">#</span><span class="bash"> https://blog.csdn.net/tanjunchen/article/details/104762428</span></span><br><span class="line"></span><br><span class="line">然后替换image成kubeimages/metrics-server:v0.5.1</span><br><span class="line"></span><br><span class="line">再kubectl apply -f components.yaml</span><br></pre></td></tr></table></figure>

<p>成功后：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~$</span><span class="bash"> kl get svc -n kube-system</span></span><br><span class="line">NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">kube-dns         ClusterIP   10.20.0.10     &lt;none&gt;        53/UDP,53/TCP,9153/TCP   8d</span><br><span class="line">metrics-server   ClusterIP   10.20.204.13   &lt;none&gt;        443/TCP                  18m</span><br></pre></td></tr></table></figure>



<h2 id="运行kube-bench"><a href="#运行kube-bench" class="headerlink" title="运行kube-bench"></a>运行kube-bench</h2><p>kube-bench用来检查集群有哪些配置不够安全。</p>
<p>参考文档：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/aquasecurity/kube-bench/blob/main/docs/installation.md</span><br><span class="line">https://github.com/aquasecurity/kube-bench/blob/main/docs/running.md</span><br></pre></td></tr></table></figure>

<p>二进制安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> install</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 0.6.6开始支持arm了, 所以可以直接装到树莓派上</span></span><br><span class="line">wget https://github.com/aquasecurity/kube-bench/releases/download/v0.6.6/kube-bench_0.6.6_linux_arm64.deb</span><br><span class="line">sudo apt install ./kube-bench_0.6.6_linux_arm64.deb</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> execute</span></span><br><span class="line">kube-bench  --config-dir /etc/kube-bench/cfg --config ./cfg/config.yaml</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这是config默认路径，<span class="built_in">help</span>中有</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kube-bench不带参就是检查/etc/kube-bench/cfg/config.yaml。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -c 1.1.8 可以指定检查哪一项</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 结果可在控制台直接看到</span></span><br></pre></td></tr></table></figure>

<p>yaml安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/aquasecurity/kube-bench.git</span><br><span class="line">cd kube-bench</span><br><span class="line"><span class="meta">#</span><span class="bash"> kubectl apply -f job-master.yaml</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kubectl apply -f job-worker.yaml</span></span><br><span class="line">kubectl apply -f job.yaml # 检查全部</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看结果</span></span><br><span class="line"><span class="meta">~/kube-bench$</span><span class="bash"> kl get pod -A | grep kube-bench</span></span><br><span class="line">default         kube-bench--1-ddvrh                         0/1     Completed   0               3m53s</span><br><span class="line"><span class="meta">~/kube-bench$</span><span class="bash"> kl logs kube-bench--1-ddvrh</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>你还需要下载一个pdf文档，这个文档会对每一个检查条目做详细的说明并给出问题的解决方法。</p>
<p>到<a target="_blank" rel="noopener" href="https://downloads.cisecurity.org/">CIS下载网站</a>,定位到Kubernetes相关的下载项，下载”CIS Kubernetes V1.20 Benchmark v1.0.0”(你看到的时候版本可能不一样了)。</p>
<p><img src="/linkimage/cksknowledge/kube-bench-k8s-pdf.png" alt="CIS下载网站"></p>
<p>基于我前面使用kubeadm安装的集群，下面会列举出kube-bench测出来的一些问题。</p>
<h3 id="设置权限"><a href="#设置权限" class="headerlink" title="设置权限"></a>设置权限</h3><h4 id="kubelet权限"><a href="#kubelet权限" class="headerlink" title="kubelet权限"></a>kubelet权限</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chmod 644 /usr/lib/systemd/system/kubelet.service</span><br><span class="line">chown root:root /usr/lib/systemd/system/kubelet.service</span><br><span class="line">chmod 644 /etc/kubernetes/kubelet.conf</span><br></pre></td></tr></table></figure>

<h4 id="cni权限"><a href="#cni权限" class="headerlink" title="cni权限"></a>cni权限</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 644 /etc/cni/net.d/10-weave.conflist</span><br><span class="line">chown root:root /etc/cni/net.d/10-weave.conflist</span><br></pre></td></tr></table></figure>

<h4 id="etcd权限"><a href="#etcd权限" class="headerlink" title="etcd权限"></a>etcd权限</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">useradd etcd</span><br><span class="line">chown etcd:etcd /var/lib/etcd</span><br></pre></td></tr></table></figure>




<h3 id="kubelet配置参数"><a href="#kubelet配置参数" class="headerlink" title="kubelet配置参数"></a>kubelet配置参数</h3><h4 id="authentication"><a href="#authentication" class="headerlink" title="authentication"></a>authentication</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vi /var/lib/kubelet/config.yaml</span><br><span class="line"># ensure anonymous is false</span><br><span class="line"># ensure clientCAFile is configured</span><br><span class="line"></span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: false</span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 0s</span><br><span class="line">    enabled: true</span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: /etc/kubernetes/pki/ca.crt</span><br></pre></td></tr></table></figure>

<p>注意上面的配置是kubeadm安装后默认的配置，没有什么问题。其中关于webhook的知识可以参考：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://kubernetes.io/docs/reference/access-authn-authz/webhook/</span><br><span class="line">mode Webhook causes Kubernetes to query an outside REST service when determining user privileges.</span><br><span class="line">也就是webhook会触发一个rest请求到外部服务来决定一个请求是否有权限。</span><br></pre></td></tr></table></figure>



<h4 id="protectKernelDefaults"><a href="#protectKernelDefaults" class="headerlink" title="protectKernelDefaults"></a>protectKernelDefaults</h4><p>protectKernelDefaults是决定k8s一个行为，当内核参数不满足k8s的期待的时候，k8s是报错还是修改内核参数。如果true就是报错，如果false就是修改。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">protectKernelDefaults, if true, causes the Kubelet to error if kernel </span><br><span class="line">flags are not as it expects. Otherwise the Kubelet will attempt to </span><br><span class="line">modify kernel flags to match its expectation.</span><br><span class="line"></span><br><span class="line">配置方法是 vi /var/lib/kubelet/config.yaml</span><br><span class="line">并添加protectKernelDefaults: true </span><br><span class="line">默认是false</span><br></pre></td></tr></table></figure>

<p>k8s因为该参数启动失败报错的一个例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">https://www.ibm.com/docs/zh/cloud-private/3.1.2?topic=upgrade-kubelet-container-fails-start</span><br><span class="line"></span><br><span class="line">kubelet的protectKernelDefaults可能导致kubelet启动失败，错误信息类似：</span><br><span class="line">hyperkube[804]: F1023 17:02:19.964867     804 kubelet.go:1333] Failed to start ContainerManager [Invalid kernel flag: vm/overcommit_memory, expected value: 1, actual value: 0, Invalid kernel flag: kernel/panic, expected value: 10, actual value: 0, Invalid kernel flag: kernel/panic_on_oops, expected value: 1, actual value: 0]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在我的集群中如果开启了就会报错。</p>
<h4 id="eventRecordQPS-eventBurst"><a href="#eventRecordQPS-eventBurst" class="headerlink" title="eventRecordQPS&#x2F;eventBurst"></a>eventRecordQPS&#x2F;eventBurst</h4><p>这两个参数是对kubelet产生的event进行流控的(event会上报给apiserver)，eventRecordQPS是控制qps，eventBurst是控制令牌桶的桶大小。设小了会丢event，设大了对apiserver可能产生潜在压力，对于我们个人搭建的小集群，设大一点就可以了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/</span><br><span class="line"></span><br><span class="line">vi /var/lib/kubelet/config.yaml</span><br><span class="line"># add below two lines</span><br><span class="line">eventRecordQPS: 100</span><br><span class="line">eventBurst: 200</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="apiserver配置参数"><a href="#apiserver配置参数" class="headerlink" title="apiserver配置参数"></a>apiserver配置参数</h3><h4 id="anonymous-auth"><a href="#anonymous-auth" class="headerlink" title="anonymous-auth"></a>anonymous-auth</h4><p>设置为true时候，如果一个请求没被别的验证流程拦截，那么这个请求就作为一个匿名请求，比如你不提供token的时候（不同于提供错误的token）。匿名请求的用户名和组分别为 <code>system:anonymous</code>和<code>system:unauthenticated</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">https://kubernetes.io/docs/reference/access-authn-authz/authentication/#anonymous-requests</span><br><span class="line"></span><br><span class="line">/etc/kubernetes/manifests/kube-apiserver.yaml 中添加参数</span><br><span class="line">--anonymous-auth=false</span><br><span class="line"></span><br><span class="line">但设为true不是必须的，设置了会影响health check。</span><br><span class="line">If you are using RBAC authorization, it is generally considered reasonable to allow anonymous access to the API Server for health checks and discovery purposes, and hence this recommendation is not scored. However, you should consider whether anonymous discovery is an acceptable risk for your purposes.</span><br><span class="line"></span><br><span class="line">设为false可能会引起问题:</span><br><span class="line">https://github.com/kubernetes/kubeadm/issues/798#issuecomment-470579937</span><br><span class="line">https://github.com/kubernetes/kubernetes/issues/51076#issuecomment-412846482</span><br><span class="line">so leave anonymous-auth=true(default value) with RBAC is ok.</span><br></pre></td></tr></table></figure>



<h4 id="kubelet-certificate-authority"><a href="#kubelet-certificate-authority" class="headerlink" title="kubelet-certificate-authority"></a>kubelet-certificate-authority</h4><p>在默认的时候，apiserver访问kubelet的时候，当然，会走ssl验证，但是只会做单向验证，也就是kubelet会验证apiserver，apiserver不会验证kubelet的身份。kubelet-certificate-authority被设置的时候，apiserver访问kubelet时，apiserver就会验证kubelet的身份，并使用kubelet-certificate-authority配置的CA文件来验证。这里我们使用与集群相同的ca文件（default at &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca.crt）来创建kubelet server的证书：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">首先给kubelet server2创建证书：</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; 1. 创建csr配置文件</span><br><span class="line">vi kubelet-server2.conf</span><br><span class="line"></span><br><span class="line">[ req ]</span><br><span class="line">default_bits = 2048</span><br><span class="line">prompt = no</span><br><span class="line">default_md = sha256</span><br><span class="line">req_extensions = req_ext</span><br><span class="line">distinguished_name = dn</span><br><span class="line"></span><br><span class="line">[ dn ]</span><br><span class="line">O = system:nodes</span><br><span class="line">CN = system:node:server2</span><br><span class="line"></span><br><span class="line">[ req_ext ]</span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line"></span><br><span class="line">[ alt_names ]</span><br><span class="line">DNS.1 = server2</span><br><span class="line">IP.1 = 192.168.3.152</span><br><span class="line"></span><br><span class="line">[ v3_ext ]</span><br><span class="line">authorityKeyIdentifier=keyid,issuer:always</span><br><span class="line">basicConstraints=CA:FALSE</span><br><span class="line">keyUsage=keyEncipherment,dataEncipherment</span><br><span class="line">extendedKeyUsage=serverAuth</span><br><span class="line">subjectAltName=@alt_names</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; 2. 创建server证书</span><br><span class="line"># 创建key</span><br><span class="line">openssl genrsa -out kubelet-server2.key 2048</span><br><span class="line"># 创建csr</span><br><span class="line">openssl req -new -key kubelet-server2.key -out kubelet-server2.csr -config kubelet-server2.conf</span><br><span class="line"># 创建crt</span><br><span class="line">openssl x509 -req -in kubelet-server2.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out kubelet-server2.crt -days 366 -extensions v3_ext -extfile kubelet-server2.conf</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; 3. copy files to server2</span><br><span class="line">scp -P 22 kubelet-server2* root@192.168.3.152:/var/lib/kubelet/pki/</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; 4. config kubelet config file</span><br><span class="line">vi /var/lib/kubelet/config.yaml # add below two</span><br><span class="line"># tlsCertFile: /var/lib/kubelet/pki/kubelet-server2.crt</span><br><span class="line"># tlsPrivateKeyFile: /var/lib/kubelet/pki/kubelet-server2.key</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; 5. config apiserver command line</span><br><span class="line">vi /etc/kubernetes/manifests/kube-apiserver.yaml # add below one</span><br><span class="line"># - --kubelet-certificate-authority=/etc/kubernetes/pki/ca.crt</span><br></pre></td></tr></table></figure>

<p>注意上面的流程中既包含apiserver的参数kubelet-certificate-authority，也包含kubelet需要配置的参数tlsCertFile和tlsPrivateKeyFile。</p>
<p>经过验证，如果kubelet使用全新的ca来签名（而不是当前集群使用的CA），然后把全新的这个ca的cert配到apiserver的–kubelet-certificate-authority，这时候apiserver请求kubelet会出现unknown ca的错误，不成功，应该是这个全新ca还没有添加到apiserver的可信ca中。这个方向没有继续探索。</p>
<h4 id="admission-control-EventRateLimit"><a href="#admission-control-EventRateLimit" class="headerlink" title="admission-control EventRateLimit"></a>admission-control EventRateLimit</h4><p>admission-control是apiserver提供的一系列内置的控制插件，可以拦截和修改请求。</p>
<p>eventratelimit是用来控制请求的qps的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#eventratelimit</span><br><span class="line"></span><br><span class="line">总体步骤是：</span><br><span class="line">先创建好配置文件admission-control-config-file.yaml和eventconfig.yaml，然后修改kube-apiserver.yaml</span><br><span class="line"></span><br><span class="line"># 创建配置文件存放的目录</span><br><span class="line">sudo mkdir /etc/kubernetes/admission/</span><br><span class="line">cd /etc/kubernetes/admission/</span><br><span class="line"></span><br><span class="line"># 配置admission-control-config-file.yaml，总的插件配置文件</span><br><span class="line">/etc/kubernetes/admission$ sudo vi admission-control-config-file.yaml</span><br><span class="line">apiVersion: apiserver.config.k8s.io/v1</span><br><span class="line">kind: AdmissionConfiguration</span><br><span class="line">plugins:</span><br><span class="line">- name: EventRateLimit</span><br><span class="line">  path: eventconfig.yaml</span><br><span class="line"></span><br><span class="line"># 配置eventconfig.yaml</span><br><span class="line"># burst是令牌桶的桶大小，cacheSize是指LRU中最多存放多少个namespace/user的配置值</span><br><span class="line">/etc/kubernetes/admission$ sudo vi eventconfig.yaml </span><br><span class="line">apiVersion: eventratelimit.admission.k8s.io/v1alpha1</span><br><span class="line">kind: Configuration</span><br><span class="line">limits:</span><br><span class="line">- type: Namespace</span><br><span class="line">  qps: 50</span><br><span class="line">  burst: 100</span><br><span class="line">  cacheSize: 2000</span><br><span class="line">- type: User</span><br><span class="line">  qps: 10</span><br><span class="line">  burst: 50</span><br><span class="line">  cacheSize: 1000</span><br><span class="line"></span><br><span class="line"># 配置kube-apiserver.yaml</span><br><span class="line"># enable-admission-plugins参数打开EventRateLimit项，</span><br><span class="line"># admission-control-config-file参数配置总的插件配置文件</span><br><span class="line"># mount created new directory</span><br><span class="line"></span><br><span class="line">/etc/kubernetes/manifests$ sudo vi kube-apiserver.yaml</span><br><span class="line"># edit two lines</span><br><span class="line">- --enable-admission-plugins=NodeRestriction,EventRateLimit</span><br><span class="line">- --admission-control-config-file=/etc/kubernetes/admission/admission-control-config-file.yaml</span><br><span class="line"></span><br><span class="line"># add</span><br><span class="line">- mountPath: /etc/kubernetes/admission</span><br><span class="line">  name: api-admission</span><br><span class="line">  readOnly: true</span><br><span class="line"></span><br><span class="line"># add</span><br><span class="line">- hostPath:</span><br><span class="line">    path: /etc/kubernetes/admission</span><br><span class="line">    type: DirectoryOrCreate</span><br><span class="line">  name: api-admission</span><br></pre></td></tr></table></figure>



<h4 id="admission-control-AlwaysPullImages"><a href="#admission-control-AlwaysPullImages" class="headerlink" title="admission-control AlwaysPullImages"></a>admission-control AlwaysPullImages</h4><p>同样是一个admission-control插件，会强制把pod中的imagePullPolicy改成Always，这么做是为了防止没有镜像拉取权限的用户利用已经缓存在本地的镜像来拉起pod。镜像拉取权限可以通过在pod中指定<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/pull-image-private-registry/">imagePullSecrets</a>来指定访问registry的用户名密码，如果不配置成Always，那么一个没有registry拉取权限的用户就可能利用缓存的镜像而运行了。</p>
<p>这个插件的逻辑比较简单，就是把imagePullPolicy强制改成Always。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">参考文档：</span><br><span class="line">https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#alwayspullimages </span><br><span class="line">https://trstringer.com/kubernetes-alwayspullimages/</span><br></pre></td></tr></table></figure>



<h4 id="admission-control-SecurityContextDeny"><a href="#admission-control-SecurityContextDeny" class="headerlink" title="admission-control SecurityContextDeny"></a>admission-control SecurityContextDeny</h4><p>同样是一个admission-control插件,开启后会禁止SecurityContext中的部分字段，但并不是禁止securitycontext中的所有字段。开了PodSecurityPolicy插件的话这个就不需要开启。kube-bench对SecurityContextDeny和PodSecurityPolicy只要有一个开了就不会报了，不过PodSecurityPolicy比SecurityContextDeny要复杂很多。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">开启后会禁止SecurityContext中的RunAsUser等字段,pod级别的和container级别的都有字段会涉及.</span><br><span class="line">代码在plugin/pkg/admission/securitycontext/scdeny/admission.go</span><br><span class="line">// Validate will deny any pod that defines SupplementalGroups, SELinuxOptions, RunAsUser or FSGroup</span><br></pre></td></tr></table></figure>



<h4 id="admission-control-PodSecurityContext"><a href="#admission-control-PodSecurityContext" class="headerlink" title="admission-control PodSecurityContext"></a>admission-control PodSecurityContext</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">禁止SecirityContex中的一些字段,但是这个PodSecurityContext已经被deprecated了.</span><br></pre></td></tr></table></figure>



<h4 id="insecure-port"><a href="#insecure-port" class="headerlink" title="insecure port"></a>insecure port</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">insecure-bind-address, insecure-port, port</span><br><span class="line">apiserver这几个参数都已经废除,并且不会再被使用了. 所以这几个参数不用管。</span><br></pre></td></tr></table></figure>



<h4 id="profiling"><a href="#profiling" class="headerlink" title="profiling"></a>profiling</h4><p>–profiling&#x3D;false</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">这个是关闭pprof页面. 如果需要这个页面就不要关闭,然后通过下面的步骤查看:</span><br><span class="line"></span><br><span class="line">:~# kubectl proxy</span><br><span class="line">Starting to serve on 127.0.0.1:8001</span><br><span class="line"></span><br><span class="line">:~# wget http://127.0.0.1:8001/debug/pprof</span><br><span class="line"></span><br><span class="line">apiserver scheduler controller-manager都可以关闭。</span><br></pre></td></tr></table></figure>



<h4 id="audit-policy-file"><a href="#audit-policy-file" class="headerlink" title="audit-policy-file"></a>audit-policy-file</h4><p>审计功能就是给请求记录日志，不同的请求可以设置不同的日志级别，比如只记录metadata，只记录request，等等。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">参考：</span><br><span class="line">https://kubernetes.io/docs/tasks/debug-application-cluster/audit/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; 1. 创建audit-policy.yaml</span></span><br><span class="line">vi /etc/kubernetes/audit-policy.yaml</span><br><span class="line"><span class="meta">#</span><span class="bash"> 简单版的policy</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Log all requests at the Metadata level.</span></span><br><span class="line">apiVersion: audit.k8s.io/v1</span><br><span class="line">kind: Policy</span><br><span class="line">rules:</span><br><span class="line">- level: Metadata</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; 2. 配置apiserver参数</span></span><br><span class="line">    - --audit-policy-file=/etc/kubernetes/audit-policy.yaml</span><br><span class="line">    - --audit-log-path=/var/log/kubernetes/audit/audit.log</span><br><span class="line">    - --audit-log-maxage=15</span><br><span class="line">    - --audit-log-maxbackup=10</span><br><span class="line">    - --audit-log-maxsize=10</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; 3. 挂载相关文件和目录</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="bash">volumeMounts:</span></span><br><span class="line">    - mountPath: /etc/kubernetes/audit-policy.yaml</span><br><span class="line">      name: audit-policy</span><br><span class="line">      readOnly: true</span><br><span class="line">    - mountPath: /var/log/kubernetes/audit</span><br><span class="line">      name: audit-log</span><br><span class="line">      readOnly: false</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="bash">volumes:</span></span><br><span class="line">  - hostPath:</span><br><span class="line">      path: /etc/kubernetes/audit-policy.yaml</span><br><span class="line">      type: File</span><br><span class="line">    name: audit-policy</span><br><span class="line">  - hostPath:</span><br><span class="line">      path: /var/log/kubernetes/audit</span><br><span class="line">      type: DirectoryOrCreate</span><br><span class="line">    name: audit-log</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>之后你在&#x2F;var&#x2F;log&#x2F;kubernetes&#x2F;audit&#x2F;audit.log文件中就能看到apiserver的请求日志了。</p>
<h4 id="encryption-provider-config"><a href="#encryption-provider-config" class="headerlink" title="encryption-provider-config"></a>encryption-provider-config</h4><p>对写入etcd的数据进行编码，对读取的数据进行解码，这样用户直接读etcd的数据就会是乱码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">参考：</span><br><span class="line">https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/</span><br><span class="line"></span><br><span class="line">因为我们在”admission-control EventRateLimit“小节已经挂载了/etc/kubernetes/admission目录，所以这里不再配置挂载/etc/kubernetes/admission的操作。</span><br><span class="line"></span><br><span class="line">编辑encrypt-config.yaml文件：</span><br><span class="line">vi /etc/kubernetes/admission/encrypt-config.yaml</span><br><span class="line">apiVersion: apiserver.config.k8s.io/v1</span><br><span class="line">kind: EncryptionConfiguration</span><br><span class="line">resources:</span><br><span class="line">  - resources:</span><br><span class="line">    - secrets</span><br><span class="line">    providers:</span><br><span class="line">    - aescbc:</span><br><span class="line">        keys:</span><br><span class="line">        - name: key1</span><br><span class="line">          secret: &lt;BASE 64 ENCODED SECRET&gt;</span><br><span class="line">    - identity: &#123;&#125;</span><br><span class="line"></span><br><span class="line">其中secret通过</span><br><span class="line">head -c 32 /dev/urandom | base64</span><br><span class="line">获取。集群内用来HA的多个apiserver要用同一个secret。</span><br><span class="line"></span><br><span class="line">然后通过--encryption-provider-config参数传给apiserver。</span><br><span class="line">--encryption-provider-config=/etc/kubernetes/admission/encrypt-config.yaml</span><br></pre></td></tr></table></figure>

<p>注意providers下的项目中，第一个provider的项用于加密，所有providers项用于依次解密。在我们的配置中key1用于加密，解密会先用key1解，解不出就用第二项解，第二项是空的，也就是原样返回。通常providers最后一项配为空，这样就可以防止在encrypt-config.yaml应用前存入的不加密数据会读不出来。</p>
<p>我们可以验证一下EncryptionConfiguration的功能：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 首先创建一个读etcd的脚本，方便操作：</span></span><br><span class="line">vi read_etcd_resource.sh </span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="variable">$1</span> resource</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="variable">$2</span> namespace</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="variable">$3</span> resource name</span></span><br><span class="line">ETCDCTL_API=3 etcdctl --endpoints 127.0.0.1:2379 \</span><br><span class="line">  --cert=/etc/kubernetes/pki/etcd/server.crt \</span><br><span class="line">  --key=/etc/kubernetes/pki/etcd/server.key \</span><br><span class="line">  --cacert=/etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">  get /registry/$1/$2/$3</span><br><span class="line"><span class="meta">  </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证encrypt的方法：</span></span><br><span class="line">kubectl get secret</span><br><span class="line"><span class="meta">#</span><span class="bash"> 选择一个encrypt-config.yaml应用前已经存在的secre，比如tdefault-token-xxxxx</span></span><br><span class="line">sh etcd_read.sh secrets default default-token-xxxxx</span><br><span class="line"><span class="meta">#</span><span class="bash"> 返回可读明文。</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建一个新的secret</span></span><br><span class="line">kubectl create secret generic xx --from-literal aa==bb</span><br><span class="line"><span class="meta">#</span><span class="bash"> 读取先的secret</span></span><br><span class="line">sh etcd_read.sh secrets default xx</span><br><span class="line"><span class="meta">#</span><span class="bash"> 返回乱码，证明新建的secret已经被encode了</span></span><br></pre></td></tr></table></figure>



<h4 id="tls-cipher-suites"><a href="#tls-cipher-suites" class="headerlink" title="tls-cipher-suites"></a>tls-cipher-suites</h4><p>设置tls支持的加密算法，由于部分加密算法是不安全的，所以我们需要把支持的加密算法枚举出来，不安全的不枚举就不会被使用。枚举出的算法名配到tls-cipher-suites即可。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">参考：</span><br><span class="line">https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/</span><br><span class="line">--tls-cipher-suites strings              Comma-separated list of cipher</span><br><span class="line"> suites for the server. If omitted, the default Go cipher suites will be</span><br><span class="line"> used.</span><br><span class="line">有部分算法是不够安全的。不传的话是使用的默认算法列表，取决于tls内部，默认值不是k8s指定的。</span><br><span class="line"></span><br><span class="line">上面kubernetes文档里有给出建议的选项(要删掉空格)。</span><br><span class="line">Comma-separated list of cipher suites for the server. If omitted, the default Go cipher suites will be used.</span><br><span class="line">Preferred values: TLS_AES_128_GCM_SHA256, TLS_AES_256_GCM_SHA384, TLS_CHACHA20_POLY1305_SHA256, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384, TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305, TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384, TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305, TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256, TLS_RSA_WITH_AES_128_CBC_SHA, TLS_RSA_WITH_AES_128_GCM_SHA256, TLS_RSA_WITH_AES_256_CBC_SHA, TLS_RSA_WITH_AES_256_GCM_SHA384.</span><br><span class="line">Insecure values: TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_RC4_128_SHA, TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_RSA_WITH_RC4_128_SHA, TLS_RSA_WITH_3DES_EDE_CBC_SHA, TLS_RSA_WITH_AES_128_CBC_SHA256, TLS_RSA_WITH_RC4_128_SHA.</span><br></pre></td></tr></table></figure>



<h4 id="request-timeout"><a href="#request-timeout" class="headerlink" title="request-timeout"></a>request-timeout</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">文档：</span><br><span class="line">https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/</span><br><span class="line"></span><br><span class="line">--request-timeout表示apiserver可以维持一个链接直到超时的时间。</span><br><span class="line">比如--request-timeout=300s。</span><br><span class="line"></span><br><span class="line">还有个--min-request-timeout，专用于watch request handler的超时时间，</span><br><span class="line">实际超时时间是在min-request-timeout之上加一个随机值。</span><br></pre></td></tr></table></figure>



<h3 id="controller-manager配置参数"><a href="#controller-manager配置参数" class="headerlink" title="controller manager配置参数"></a>controller manager配置参数</h3><h4 id="terminated-pod-gc-threshold"><a href="#terminated-pod-gc-threshold" class="headerlink" title="terminated-pod-gc-threshold"></a>terminated-pod-gc-threshold</h4><p>已经结束的pod（succeed和failed）不会自动删除，直到某个控制器删除或者手动删除。</p>
<p>–terminated-pod-gc-threshold配置后，当超过配置值数量pod结束后，就会触发清理，超过几个就清理几个。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">文档：</span><br><span class="line">https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#pod-garbage-collection</span><br><span class="line"></span><br><span class="line">代码在pkg/controller/podgc/gc_controller.go 的 func (gcc *PodGCController) gcTerminated(pods []*v1.Pod)</span><br><span class="line"></span><br><span class="line">The control plane cleans up terminated Pods (with a phase of Succeeded or Failed), when the number of Pods exceeds the configured threshold (determined by terminated-pod-gc-threshold in the kube-controller-manager).</span><br></pre></td></tr></table></figure>



<h4 id="profiling-1"><a href="#profiling-1" class="headerlink" title="profiling"></a>profiling</h4><p>在apiserver中我们已经禁用了apiserver的profiling，那么相应的controller manager的profiling也应该被禁用掉。给controller manager配置命令行参数–profiling&#x3D;false即可。</p>
<p>不过这里要补充一个知识，如何在controller manager的profiling打开的情况下，查看pprof页面。思路是在请求中带上TOKEN，并且给token对应的用户一个对应的权限。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># get default user token</span><br><span class="line">kubectl describe secret $(kubectl get secrets -n default | grep ^default | cut -f1 -d &#x27; &#x27;) -n default | grep -E &#x27;^token&#x27; | cut -f2 -d&#x27;:&#x27; | tr -d &quot; &quot;</span><br><span class="line"></span><br><span class="line"># set token var</span><br><span class="line">TOKEN=xxx  # 上一条命令的内容</span><br><span class="line"></span><br><span class="line"># apply clusterrolebinding</span><br><span class="line">kl apply -f role.yaml</span><br><span class="line"></span><br><span class="line"># 访问带上token</span><br><span class="line">curl https://127.0.0.1:10257/debug/pprof/goroutine?debug=2 -k --header &quot;Authorization: Bearer $TOKEN&quot;</span><br><span class="line">curl https://127.0.0.1:10259/debug/pprof/goroutine?debug=2 -k --header &quot;Authorization: Bearer $TOKEN&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># 其中role.yaml内容如下：</span><br><span class="line"></span><br><span class="line">cat role.yaml</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: debug-cluster-role</span><br><span class="line">rules:</span><br><span class="line">- nonResourceURLs:</span><br><span class="line">  - /debug/pprof/profile</span><br><span class="line">  - /debug/pprof/goroutine</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: debug-binding</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: debug-cluster-role</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: default</span><br><span class="line">  namespace: default</span><br></pre></td></tr></table></figure>



<h3 id="scheduller配置参数"><a href="#scheduller配置参数" class="headerlink" title="scheduller配置参数"></a>scheduller配置参数</h3><h4 id="profiling-2"><a href="#profiling-2" class="headerlink" title="profiling"></a>profiling</h4><p>同apiserver和controll manager,配置命令行参数–profiling&#x3D;false即可。</p>
<h2 id="automountServiceAccountToken"><a href="#automountServiceAccountToken" class="headerlink" title="automountServiceAccountToken"></a>automountServiceAccountToken</h2><p>我们创建pod的时候会自动挂载一个user，默认就是default，这个用户的token会挂载在&#x2F;var&#x2F;run&#x2F;secrets&#x2F;kubernetes.io&#x2F;serviceaccount&#x2F;token下，但是出于安全考虑，我们希望不要被自动挂载。</p>
<p>pod和service account都可以设置automountServiceAccountToken这个字段，都设置了的话pod中的automountServiceAccountToken字段优先。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server</span><br><span class="line"></span><br><span class="line"># sa中配置</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: build-robot</span><br><span class="line">automountServiceAccountToken: false</span><br><span class="line"></span><br><span class="line"># pod中配置</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: my-pod</span><br><span class="line">spec:</span><br><span class="line">  serviceAccountName: build-robot</span><br><span class="line">  automountServiceAccountToken: false</span><br></pre></td></tr></table></figure>



<h2 id="secret管理"><a href="#secret管理" class="headerlink" title="secret管理"></a>secret管理</h2><p>secret可以挂载到env或者volume中，但是由于环境变量容易暴露到日志中，因此secret应该尽量使用volume挂载而不是env。</p>
<p>secret如果有更复杂的管理，或者需要跨k8s或者在非k8s环境下使用，还是需要进行外部管理的。</p>
<h2 id="seccomp-default"><a href="#seccomp-default" class="headerlink" title="seccomp default"></a>seccomp default</h2><p>seccomp是操作系统用来限制进程的syscall的，k8s可以配置seccomp来限制容器中进程的syacall权限，哪些能call哪些不能call。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">文档：</span><br><span class="line">https://kubernetes.io/blog/2021/08/25/seccomp-default/</span><br><span class="line">https://kubernetes.io/docs/reference/command-line-tools-reference/feature-gates/</span><br><span class="line"></span><br><span class="line">默认情况下k8s传给cri的seccomp是Unconfined，即不限制syscall。</span><br><span class="line">设置SeccompDefault后，会使用cri默认的seccomp，不同cri可能默认是不同的。</span><br><span class="line">If not specified differently in the pod manifest, then the feature will add a higher set of security constraints by using the default profile of the container runtime. </span><br><span class="line">These profiles may differ between runtimes like CRI-O or containerd. They also differ for its used hardware architectures</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们使用下面的步骤也验证seccomp default生效了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># 获取目前的seccomp</span><br><span class="line">kl run ng --image nginx --restart=Never</span><br><span class="line">CONTAINER_ID=$(sudo crictl --runtime-endpoint=/run/containerd/containerd.sock ps -q --name=ng)</span><br><span class="line">sudo crictl --runtime-endpoint=/run/containerd/containerd.sock inspect $CONTAINER_ID | jq .info.runtimeSpec.linux.seccomp</span><br><span class="line"># 返回null</span><br><span class="line"></span><br><span class="line"># 配置seccomp default</span><br><span class="line">root@k8sserver2:~# vi /etc/default/kubelet </span><br><span class="line">KUBELET_EXTRA_ARGS=&quot;--feature-gates=&#x27;SeccompDefault=true&#x27; --seccomp-default=RuntimeDefault&quot;</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart kubelet</span><br><span class="line"></span><br><span class="line"># 获取新的seccomp</span><br><span class="line">kl run gn --image nginx --restart=Never</span><br><span class="line">CONTAINER_ID=$(sudo crictl --runtime-endpoint=/run/containerd/containerd.sock ps -q --name=gn)</span><br><span class="line">sudo crictl --runtime-endpoint=/run/containerd/containerd.sock inspect $CONTAINER_ID | jq .info.runtimeSpec.linux.seccomp</span><br><span class="line"># 返回</span><br><span class="line">#&#123;</span><br><span class="line">#  &quot;defaultAction&quot;: &quot;SCMP_ACT_ERRNO&quot;,</span><br><span class="line">#  &quot;architectures&quot;: [</span><br><span class="line">#    &quot;SCMP_ARCH_ARM&quot;,</span><br><span class="line">#    &quot;SCMP_ARCH_AARCH64&quot;</span><br><span class="line">#  ],</span><br><span class="line">#  &quot;syscalls&quot;: [</span><br><span class="line">#    &#123;</span><br><span class="line">#      &quot;names&quot;: [</span><br><span class="line">#        &quot;accept&quot;,</span><br><span class="line">#        &quot;accept4&quot;,</span><br><span class="line"># ......</span><br></pre></td></tr></table></figure>



<h2 id="seccomp-localhost"><a href="#seccomp-localhost" class="headerlink" title="seccomp localhost"></a>seccomp localhost</h2><p>上面看了如何使用默认的seccomp，那么如果使用自定义的seccomp呢，可以看下面的步骤：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">文档：</span><br><span class="line">https://kubernetes.io/docs/tutorials/clusters/seccomp/</span><br><span class="line"></span><br><span class="line"># 创建/var/lib/kubelet/seccomp,这个是seccomp文件默认被查找的位置</span><br><span class="line">mkdir /var/lib/kubelet/seccomp</span><br><span class="line">cd /var/lib/kubelet/seccomp</span><br><span class="line"></span><br><span class="line"># 下载所需的seccomp文件，我们这个seccomp的作用的对syscall进行日志记录，不做syscall拦截</span><br><span class="line">curl -L -o profiles/audit.json https://k8s.io/examples/pods/security/seccomp/profiles/audit.json</span><br><span class="line">#curl -L -o profiles/violation.json https://k8s.io/examples/pods/security/seccomp/profiles/violation.json</span><br><span class="line">#curl -L -o profiles/fine-grained.json https://k8s.io/examples/pods/security/seccomp/profiles/fine-grained.json</span><br><span class="line">ls profiles</span><br><span class="line"># audit.json  fine-grained.json  violation.json</span><br><span class="line"></span><br><span class="line"># 创建pod的yaml，里面包含自定义seccom配置localhostProfile: profiles/audit.json</span><br><span class="line">vi audit-log.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: audit-pod</span><br><span class="line">  labels:</span><br><span class="line">    app: audit-pod</span><br><span class="line">spec:</span><br><span class="line">  securityContext:</span><br><span class="line">    seccompProfile:</span><br><span class="line">      type: Localhost</span><br><span class="line">      localhostProfile: profiles/audit.json</span><br><span class="line">  containers:</span><br><span class="line">  - name: test-container</span><br><span class="line">    image: nginx</span><br><span class="line">    </span><br><span class="line"># 查看pod的ip:port</span><br><span class="line">kubectl apply -f audit-log.yaml</span><br><span class="line">kubectl expose pod audit-pod --type NodePort --port 80</span><br><span class="line">kubectl get service audit-pod</span><br><span class="line">NAME        TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">audit-pod   NodePort   10.20.162.9   &lt;none&gt;        80:31676/TCP   7s</span><br><span class="line"></span><br><span class="line"># 访问ip:port并查看日志</span><br><span class="line">访问ip:port</span><br><span class="line">curl 10.20.162.9</span><br><span class="line">同时在另一个终端查看日志</span><br><span class="line">tail -f /var/log/syslog</span><br><span class="line">可以看到这些日志：</span><br><span class="line">Dec 26 11:45:54 k8sserver2 kernel: [57795.753820] kauditd_printk_skb: 6 callbacks suppressed</span><br><span class="line">Dec 26 11:45:54 k8sserver2 kernel: [57795.753832] audit: type=1326 audit(1640519154.116:2520): auid=4294967295 uid=101 gid=101 ses=4294967295 subj=cri-containerd.apparmor.d pid=21257 comm=&quot;nginx&quot; exe=&quot;/usr/sbin/nginx&quot; sig=0 arch=c00000b7 syscall=242 compat=0 ip=0xffffb7021d14 code=0x7ffc0000</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">经过验证如果拿掉pod中seccompProfile配置，就不能看到日志。说明seccomp生效了。</span><br></pre></td></tr></table></figure>



<h2 id="privileges-risk"><a href="#privileges-risk" class="headerlink" title="privileges risk"></a>privileges risk</h2><p>这部分知识比较偏向攻击层面，而不是防守层面。我们是通过学习他的攻击方式来加强自己在配置权限时候的安全意识。同时实际考试中并没有这一块考到，所以不想看的可以跳过。</p>
<p>存在权限风险的操作主要有4个：bind，escalate，impersonate，create pod。详细的分析和测试可以跳到<a href="https://yizhi.ren/2022/02/06/dangerousprivileges/">k8s中的危险权限</a>查看。</p>
<h2 id="podsecuritypolicy"><a href="#podsecuritypolicy" class="headerlink" title="podsecuritypolicy"></a>podsecuritypolicy</h2><p>psp是给pod增加约束的，定义哪些能做，作用范围大都是在securityContext这个结构中，其他也有，比如可以定义哪些volume是支持的，定义哪些端口是允许的。他通过限制这些结构来达到约束pod的目的。</p>
<p>但是psp是一个即将被废弃的功能，如果你看到文章的时候k8s的版本已经出到了v1.25了那么你可以不用看这部分了，根据官方文档，psp会在v1.25被彻底拿掉。至于psp的继任者<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/security/pod-security-admission/">Pod Security Admission</a>我会在后续补上，当前我安装的k8s版本还不能使用，要v1.22才能使用。</p>
<p>详细的关于psp的解说和用法可以跳到<a href="https://yizhi.ren/2022/02/07/podsecuritypolicy/">k8s中的PodSecurityPolicy</a>查看。</p>
<h2 id="CSR-approve"><a href="#CSR-approve" class="headerlink" title="CSR approve"></a>CSR approve</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">https://kubernetes.io/docs/tasks/tls/managing-tls-in-a-cluster/</span><br><span class="line">https://kubernetes.io/docs/reference/access-authn-authz/certificate-signing-requests/#signers</span><br><span class="line">https://kubernetes.io/docs/reference/access-authn-authz/certificate-signing-requests/#normal-user</span><br><span class="line"></span><br><span class="line">使用approve流程是因为集群的CA证书不应该随便拿来用，需要隐藏起来。</span><br><span class="line">这个流程是controller manager完成证书签发的流程，controller manager使用这两个参数来配置用到的ca的key和cert：</span><br><span class="line">- --cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt</span><br><span class="line">- --cluster-signing-key-file=/etc/kubernetes/pki/ca.key</span><br></pre></td></tr></table></figure>

<p>csr approve的步骤如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"># 1.创建key</span><br><span class="line">ubuntu@server2:~$ openssl genrsa -out myuser.key 2048</span><br><span class="line">Generating RSA private key, 2048 bit long modulus (2 primes)</span><br><span class="line">..............+++++</span><br><span class="line">..+++++</span><br><span class="line">e is 65537 (0x010001)</span><br><span class="line"></span><br><span class="line"># 2.创建csr</span><br><span class="line"># 这一步是交互形式的，你需要填的是Organization Name和Common Name，对应的是user的group和username，其他字段都可以不填，直接回车。这里我填的分别是system:groupx和yizhiren，你可以按需填。</span><br><span class="line">ubuntu@server2:~$ openssl req -new -key myuser.key -out myuser.csr</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &#x27;.&#x27;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [AU]:</span><br><span class="line">State or Province Name (full name) [Some-State]:</span><br><span class="line">Locality Name (eg, city) []:</span><br><span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:system:groupx</span><br><span class="line">Organizational Unit Name (eg, section) []:</span><br><span class="line">Common Name (e.g. server FQDN or YOUR name) []:yizhiren</span><br><span class="line">Email Address []:</span><br><span class="line"></span><br><span class="line">Please enter the following &#x27;extra&#x27; attributes</span><br><span class="line">to be sent with your certificate request</span><br><span class="line">A challenge password []:</span><br><span class="line">An optional company name []:</span><br><span class="line"></span><br><span class="line"># 可以使用下面的命令查看生成的csr文件</span><br><span class="line"># openssl req  -noout -text -in ./myuser.csr</span><br><span class="line"># Certificate Request:</span><br><span class="line"># ......</span><br><span class="line"></span><br><span class="line"># 3. base64 myuser.csr</span><br><span class="line">ubuntu@server2:~$ cat myuser.csr | base64 | tr -d &quot;\n&quot;</span><br><span class="line">xxxxxxxxxxxxxxxxxx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 4. 创建csr yaml文件</span><br><span class="line">vi csr.yaml</span><br><span class="line"># 这里的request就是上面base64 myuser.csr值</span><br><span class="line">apiVersion: certificates.k8s.io/v1</span><br><span class="line">kind: CertificateSigningRequest</span><br><span class="line">metadata:</span><br><span class="line">  name: myuser</span><br><span class="line">spec:</span><br><span class="line">  request: xxxxxxxxxxxxxxxxxx</span><br><span class="line">  signerName: kubernetes.io/kube-apiserver-client</span><br><span class="line">  expirationSeconds: 86400  # one day</span><br><span class="line">  usages:</span><br><span class="line">  - client auth</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"># 5. apply yaml</span><br><span class="line">ubuntu@server2:~$ kl apply -f csr.yaml</span><br><span class="line">certificatesigningrequest.certificates.k8s.io/myuser created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 6. 查看csr</span><br><span class="line">ubuntu@server2:~$ kl get csr</span><br><span class="line">NAME     AGE     SIGNERNAME                            REQUESTOR          REQUESTEDDURATION   CONDITION</span><br><span class="line">myuser   5m47s   kubernetes.io/kube-apiserver-client   kubernetes-admin   24h                 Pending</span><br><span class="line"></span><br><span class="line"># 7. approve csr</span><br><span class="line">ubuntu@server2:~$ kl certificate approve myuser</span><br><span class="line">certificatesigningrequest.certificates.k8s.io/myuser approved</span><br><span class="line"></span><br><span class="line"># 8. save crt</span><br><span class="line">kl get csr myuser -o jsonpath=&#x27;&#123;.status.certificate&#125;&#x27;| base64 -d &gt; myuser.crt</span><br><span class="line"></span><br><span class="line"># 可以使用下面的命令查看生成的crt文件</span><br><span class="line"># openssl x509  -noout -text -in ./myuser.crt</span><br><span class="line"># Certificate:</span><br><span class="line"># ......</span><br></pre></td></tr></table></figure>



<h2 id="ingress-usage"><a href="#ingress-usage" class="headerlink" title="ingress usage"></a>ingress usage</h2><p>ingress是对内部服务的代理，外部请求通过ingress再转发到svr中。</p>
<p>我们做一个使用举例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 首先创建3个svc：</span></span><br><span class="line"></span><br><span class="line">ubuntu@server2:~$ kl run ng1 --image nginx</span><br><span class="line">pod/ng1 created</span><br><span class="line">ubuntu@server2:~$ kl run ng2 --image nginx</span><br><span class="line">pod/ng2 created</span><br><span class="line">ubuntu@server2:~$ kl run ngdefault --image nginx</span><br><span class="line">pod/ngdefault created</span><br><span class="line">ubuntu@server2:~$ kl expose pod ng1 --name svr1 --port 80 --target-port 80</span><br><span class="line">service/svr1 exposed</span><br><span class="line">ubuntu@server2:~$ kl expose pod ng2 --name svr2 --port 80 --target-port 80</span><br><span class="line">service/svr2 exposed</span><br><span class="line">ubuntu@server2:~$ kl expose pod ngdefault --name svrdefault --port 80 --target-port 80</span><br><span class="line">service/svrdefault exposed</span><br><span class="line"></span><br><span class="line">ubuntu@server2:~$ kl get svc</span><br><span class="line">NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">kubernetes   ClusterIP   10.20.0.1       &lt;none&gt;        443/TCP   12d</span><br><span class="line">svr1         ClusterIP   10.20.22.214    &lt;none&gt;        80/TCP    88s</span><br><span class="line">svr2         ClusterIP   10.20.191.98    &lt;none&gt;        80/TCP    81s</span><br><span class="line">svrdefault   ClusterIP   10.20.215.248   &lt;none&gt;        80/TCP    55s</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"># 然后创建ingress yaml</span><br><span class="line">vi ingress.yaml</span><br><span class="line"># 注意rewrite-target和ingressClassName的配置</span><br><span class="line"># nginx-controller的安装可在文章靠前的小节中查看。</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: simple-fanout-example</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/rewrite-target:  /$2</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: nginx</span><br><span class="line">  defaultBackend:</span><br><span class="line">    service:</span><br><span class="line">      name: ngdefault</span><br><span class="line">      port:</span><br><span class="line">        number: 80</span><br><span class="line">  rules:</span><br><span class="line">  - host: jinqidiguo.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /svr1(/|$)(.*)</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: svr1</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br><span class="line">      - path: /svr2(/|$)(.*)</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: svr2</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br><span class="line">              </span><br><span class="line"># 然后apply </span><br><span class="line">~$ kl apply -f ingress.yaml</span><br><span class="line">ingress.networking.k8s.io/simple-fanout-example created</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后我们访问svr1和svr2:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># 查看nginx-controller的ip</span><br><span class="line">ubuntu@server2:~$ kl get svc ingress-nginx-controller -n ingress-nginx</span><br><span class="line">NAME                       TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">ingress-nginx-controller   NodePort   10.20.148.137   &lt;none&gt;        80:31724/TCP,443:31447/TCP   4d3h</span><br><span class="line"></span><br><span class="line"># 访问svr2</span><br><span class="line">ubuntu@server2:~$ curl 10.20.148.137/svr2/index.html -H &#x27;Host: jinqidiguo.com&#x27;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">html &#123; color-scheme: light dark; &#125;</span><br><span class="line">body &#123; width: 35em; margin: 0 auto;</span><br><span class="line">font-family: Tahoma, Verdana, Arial, sans-serif; &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>



<h2 id="ingress-tls"><a href="#ingress-tls" class="headerlink" title="ingress tls"></a>ingress tls</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">资料：</span><br><span class="line">https://docs.microsoft.com/en-us/azure/aks/ingress-own-tls</span><br><span class="line">https://kubernetes.io/docs/concepts/services-networking/ingress/#tls</span><br><span class="line">https://kubernetes.io/docs/concepts/configuration/secret/#tls-secrets</span><br></pre></td></tr></table></figure>

<p>上小节我们配置了ingress，此时ingress我们发现已经支持https了。但不是我们自己定义的证书。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ curl https://jinqidiguo.com/svr1 -k -v --resolve jinqidiguo.com:443:10.20.148.137</span><br><span class="line">...</span><br><span class="line">*  issuer: O=Acme Co; CN=Kubernetes Ingress Controller Fake Certificate</span><br><span class="line">...</span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>但是可以看到这时候的服务端证书是默认的一个证书”Kubernetes Ingress Controller Fake Certificate“。</p>
<p>我们这里需要做的是自定义我们自己的证书。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># 首先创建证书，这里使用ca文件直接签。</span><br><span class="line"># 你也可以使用csr流程来签发，参考链接：https://kubernetes.io/docs/tasks/tls/managing-tls-in-a-cluster/</span><br><span class="line"></span><br><span class="line"># 创建csr.conf</span><br><span class="line">vi ingress-csr.conf</span><br><span class="line">[ req ]</span><br><span class="line">default_bits = 2048</span><br><span class="line">prompt = no</span><br><span class="line">default_md = sha256</span><br><span class="line">req_extensions = req_ext</span><br><span class="line">distinguished_name = dn</span><br><span class="line"></span><br><span class="line">[ dn ]</span><br><span class="line">O = ingress-server</span><br><span class="line">CN = jinqidiguo.com</span><br><span class="line"></span><br><span class="line">[ req_ext ]</span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line"></span><br><span class="line">[ alt_names ]</span><br><span class="line">DNS.1 = jinqidiguo.com</span><br><span class="line">IP.1 = 10.20.148.137</span><br><span class="line"></span><br><span class="line">[ v3_ext ]</span><br><span class="line">authorityKeyIdentifier=keyid,issuer:always</span><br><span class="line">basicConstraints=CA:FALSE</span><br><span class="line">keyUsage=keyEncipherment,dataEncipherment</span><br><span class="line">extendedKeyUsage=serverAuth</span><br><span class="line">subjectAltName=@alt_names</span><br><span class="line"></span><br><span class="line"># 创建key</span><br><span class="line">openssl genrsa -out ingress-server.key 2048</span><br><span class="line"># 创建csr</span><br><span class="line">openssl req -new -key ingress-server.key -out ingress-server.csr -config ingress-csr.conf</span><br><span class="line"># 创建cert</span><br><span class="line">sudo openssl x509 -req -in ingress-server.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out ingress-server.crt -days 366 -extensions v3_ext -extfile ingress-csr.conf</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们得到了两个有用的文件ingress-server.crt和ingress-server.key。</p>
<p>然后创建secret，secret中保存我们创建出来的证书和key。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kl create secret tls ingress-tls-secret --cert=ingress-server.crt --key=ingress-server.key</span><br></pre></td></tr></table></figure>

<p>然后编辑ingress, 插入secret配置。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">~$ vi ingress.yaml</span><br><span class="line"># 插入tls字段</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: simple-fanout-example</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/rewrite-target:  /$2</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: nginx</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - jinqidiguo.com</span><br><span class="line">    secretName: ingress-tls-secret</span><br><span class="line">  defaultBackend:</span><br><span class="line">    service:</span><br><span class="line">      name: ngdefault</span><br><span class="line">      port:</span><br><span class="line">        number: 80</span><br><span class="line">  rules:</span><br><span class="line">  - host: jinqidiguo.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /svr1(/|$)(.*)</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: svr1</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br><span class="line">      - path: /svr2(/|$)(.*)</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: svr2</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br><span class="line">        </span><br><span class="line">    </span><br><span class="line"># 然后apply</span><br><span class="line">~$ kl apply -f ingress.yaml </span><br><span class="line">ingress.networking.k8s.io/simple-fanout-example configured</span><br></pre></td></tr></table></figure>

<p>然后我们再来测试https访问：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ curl https://jinqidiguo.com/svr1 -k -v --resolve jinqidiguo.com:443:10.20.148.137</span><br><span class="line">...</span><br><span class="line">*  subject: O=ingress-server; CN=jinqidiguo.com</span><br><span class="line">...</span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到证书已经改成我们自己的信息了。</p>
<h2 id="dashboard"><a href="#dashboard" class="headerlink" title="dashboard"></a>dashboard</h2><p>dashboard用来可视化管理集群，这里记录下如何安装并访问dashboard。主要是两个步骤，一个是安装dasshboard，一个是创建一个用户专门来访问dashboard。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># 文档</span><br><span class="line">https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/#deploying-the-dashboard-ui</span><br><span class="line">https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md</span><br><span class="line"></span><br><span class="line"># deploy dashboard</span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.4.0/aio/deploy/recommended.yaml</span><br><span class="line"></span><br><span class="line"># create user</span><br><span class="line">vi dashboard-user.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: dashboard-admin-user</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: dashboard-admin-user</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: dashboard-admin-user</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line"></span><br><span class="line">kl apply -f dashboard-user.yaml</span><br><span class="line"></span><br><span class="line"># get token from secret from serviceaccount</span><br><span class="line">kubectl -n kubernetes-dashboard get secret $(kubectl -n kubernetes-dashboard get sa/dashboard-admin-user -o jsonpath=&quot;&#123;.secrets[0].name&#125;&quot;) -o go-template=&quot;&#123;&#123;.data.token | base64decode&#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line"># visit</span><br><span class="line">kubectl proxy</span><br><span class="line">http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/</span><br><span class="line"># copy token to the page to login</span><br></pre></td></tr></table></figure>

<p>注意考试中有考到修改dashboard参数的，可以参考页面：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/kubernetes/dashboard/blob/36e967d848006dee386355c26f392f9045bc8f3d/docs/common/dashboard-arguments.md</span><br></pre></td></tr></table></figure>



<h2 id="checksum"><a href="#checksum" class="headerlink" title="checksum"></a>checksum</h2><p>为了确认已经安装的或者即将安装的二进制文件是官方提供的，我们需要检查二进制文件的摘要信息。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">goto </span><br><span class="line">https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG</span><br><span class="line">to visit change log of your k8s version</span><br><span class="line"></span><br><span class="line">然后下载指定版本的包，然后检查官方包的bin的shasum值</span><br><span class="line">bin % shasum kubelet</span><br><span class="line">97d45554c6451b9d6b17c51704ef87d3bd0abd3c  kubelet</span><br><span class="line">bin % shasum kubectl</span><br><span class="line">6ab51e83360217648c863d1f78871af806d943d5  kubectl</span><br><span class="line">bin % shasum kubeadm</span><br><span class="line">dd59c05cf549a446e3aa1e56178be110670319bd  kubeadm</span><br><span class="line"></span><br><span class="line">然后检查server中安装的bin的shasum</span><br><span class="line">server2:~# shasum /usr/bin/kubelet</span><br><span class="line">97d45554c6451b9d6b17c51704ef87d3bd0abd3c  /usr/bin/kubelet</span><br><span class="line">server2:~# shasum /usr/bin/kubectl</span><br><span class="line">6ab51e83360217648c863d1f78871af806d943d5  /usr/bin/kubectl</span><br><span class="line">server2:~# shasum /usr/bin/kubeadm</span><br><span class="line">dd59c05cf549a446e3aa1e56178be110670319bd  /usr/bin/kubeadm</span><br></pre></td></tr></table></figure>



<h2 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h2><p>rbac是k8s内部的权限管理机制，他主要有4中角色组成，user代表用户，operation代表操作行为，role代表一组operation的集合，binding关联一组user和一个role。从user到binding再到role再到operation，凡是这条线能关联上的就代表user拥有这个operation的权限。</p>
<p><img src="/linkimage/cksknowledge/rbac-link.png" alt="rbac角色"></p>
<p>图片来自<a target="_blank" rel="noopener" href="https://dominik-tornow.medium.com/inside-kubernetes-rbac-9988b08a738a">Kubernetes Role-based Authorization</a></p>
<p>RBAC起作用的阶段是在认证（Authentication）之后, 在授权（Authorization）阶段起作用。</p>
<p><img src="/linkimage/cksknowledge/rbac-authorization.png" alt="rbac角色"></p>
<p>图片来自<a target="_blank" rel="noopener" href="https://dominik-tornow.medium.com/inside-kubernetes-rbac-9988b08a738a">Inside Kubernetes RBAC</a></p>
<p>那RBAC需要学些什么呢，事实上RBAC这部分知识是跟CKA考试重叠的，我们需要注意的是在分配权限的时候要注意收缩权限，按照最小权限的原则去分配权限。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">另外列一些RBAC相关的很好的网站（不看不影响考试）:</span><br><span class="line">https://rbac.dev/ # 这个网站很棒，收集了大量rbac的好文章</span><br><span class="line">https://dominik-tornow.medium.com/inside-kubernetes-rbac-9988b08a738a</span><br><span class="line">https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="OPA-Open-Policy-Agent"><a href="#OPA-Open-Policy-Agent" class="headerlink" title="OPA(Open Policy Agent)"></a>OPA(Open Policy Agent)</h2><p>OPA是用来替代PSP的一个方案，OPA也称作Gatekeeper v1.0。</p>
<p>OPA的使用太过繁琐了，需要好多手工活。不建议学习了，考试考到的也是基于OPA的GateKeeper v3.0，所以我们可以直接学Gatekeeper v3.0.</p>
<p>如果实在想亲手尝试，可以联系我，我可以贴上来yaml和步骤，或者照着这个文档走：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.openpolicyagent.org/docs/latest/kubernetes-tutorial/</span><br></pre></td></tr></table></figure>



<h2 id="GateKeeper"><a href="#GateKeeper" class="headerlink" title="GateKeeper"></a>GateKeeper</h2><p>gatekeeper经历了3个版本，版本一就是步骤繁琐的原始OPA方案：</p>
<p><img src="/linkimage/cksknowledge/opa.png" alt="rbac角色"></p>
<p>这个版本中，opa和kube-mgmt是作为两个container，部署在同一个pod中。其中mgmt用来拉取所需的resource给opa， 并watch apiserver以便第一时间拉取更新的resource。opa则拉取bundle，bundle中包含rego语言定义的规则。这个版本最繁琐的就是你得自己创建svc(http就可以)来提供bundle的拉取服务，另外我们还得自己注册webhook，为了webhook的安全访问，我们还得为opa签发一个证书。</p>
<p>gatekeeper的版本二我们就不看了，版本三是目前最新的一个版本：</p>
<p><img src="/linkimage/cksknowledge/gatekeeper-v3.png" alt="rbac角色"></p>
<p>gatekeeper v3是在opa外部包了一层，不再使用mgmt。所以gatekeeper自己要做这么几件事：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">一个是原来mgmt的工作，watch并拉取resources；</span><br><span class="line"></span><br><span class="line">一个是新增两类CRD，一类是模板CRD(即ConstraintTemplate)，定义了规则，另一类是参数CRD(即Constraint)，这个CRD定义了规则的参数；</span><br><span class="line"></span><br><span class="line">一个是作为apiserver和opa之间的桥梁，gatekeeper和opa是运行在同一个进程的，opa作为一个库集成；gatekeeper对opa的包含关系是gatekeeper(opaframework(opa(rego()))) 。</span><br></pre></td></tr></table></figure>

<p>gatekeeper内部存储了所有的模板CRD和参数CRD，同时gatekeeper自己注册为webhook， 然后根据apiserver传过来的对象执行OPA的Query操作，query操作会拿出所有的模板CRD和参数CRD，触发模板CRD中的rego定义中的violation进行一一检查。</p>
<p>另外gatekeeper还具有审计功能，能检查全部相关resource（包括在应用gatekeeper之前的）是否符合约束。 违反约束的都在参数crd的.status.violations字段下。</p>
<p>用法如下，我们创建一个namespace的约束，要求namespace必须具有owner和usage两个lables：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># install</span><br><span class="line">~$ kl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/release-3.7/deploy/gatekeeper.yaml</span><br><span class="line">namespace/gatekeeper-system created</span><br><span class="line">resourcequota/gatekeeper-critical-pods created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/assign.mutations.gatekeeper.sh created</span><br><span class="line">......</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># apply 模板CRD</span><br><span class="line">~$ vi ConstraintTemplate.yaml</span><br><span class="line">apiVersion: templates.gatekeeper.sh/v1beta1</span><br><span class="line">kind: ConstraintTemplate</span><br><span class="line">metadata:</span><br><span class="line">  name: k8srequiredlabels</span><br><span class="line">spec:</span><br><span class="line">  crd:</span><br><span class="line">    spec:</span><br><span class="line">      names:</span><br><span class="line">        kind: K8sRequiredLabels</span><br><span class="line">      validation:</span><br><span class="line">        # Schema for the `parameters` field</span><br><span class="line">        openAPIV3Schema:</span><br><span class="line">          properties:</span><br><span class="line">            labels:</span><br><span class="line">              type: array</span><br><span class="line">              items: string</span><br><span class="line">  targets:</span><br><span class="line">    - target: admission.k8s.gatekeeper.sh</span><br><span class="line">      rego: |</span><br><span class="line">        package k8srequiredlabels</span><br><span class="line"></span><br><span class="line">        violation[&#123;&quot;msg&quot;: msg, &quot;details&quot;: &#123;&quot;missing_labels&quot;: missing&#125;&#125;] &#123;</span><br><span class="line">          provided := &#123;label | input.review.object.metadata.labels[label]&#125;</span><br><span class="line">          required := &#123;label | label := input.parameters.labels[_]&#125;</span><br><span class="line">          missing := required - provided</span><br><span class="line">          count(missing) &gt; 0</span><br><span class="line">          msg := sprintf(&quot;you must provide labels: %v&quot;, [missing])</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">~$ kl apply -f ConstraintTemplate.yaml </span><br><span class="line">constrainttemplate.templates.gatekeeper.sh/k8srequiredlabels created</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># apply 参数CRD</span><br><span class="line">~$ vi Constraint.yaml</span><br><span class="line">apiVersion: constraints.gatekeeper.sh/v1beta1</span><br><span class="line">kind: K8sRequiredLabels</span><br><span class="line">metadata:</span><br><span class="line">  name: ns-must-have-owner-usage</span><br><span class="line">spec:</span><br><span class="line">  match:</span><br><span class="line">    kinds:</span><br><span class="line">      - apiGroups: [&quot;&quot;]</span><br><span class="line">        kinds: [&quot;Namespace&quot;]</span><br><span class="line">  parameters:</span><br><span class="line">    labels: [&quot;owner&quot;,&quot;usage&quot;]</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">~$ kl apply -f Constraint.yaml </span><br><span class="line">k8srequiredlabels.constraints.gatekeeper.sh/ns-must-have-owner-usage created</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># test ns creation</span><br><span class="line">% kl create ns xx</span><br><span class="line">Error from server ([ns-must-have-owner-usage] you must provide labels: &#123;&quot;owner&quot;, &quot;usage&quot;&#125;): admission webhook &quot;validation.gatekeeper.sh&quot; denied the request: [ns-must-have-owner-usage] you must provide labels: &#123;&quot;owner&quot;, &quot;usage&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>使用感受是，这个比原生的opa(即gatekeeper v1)要好用。<br>相同点是都免不了需要编写rego规则，这点还是比较烦人，因为有学习成本。<br>相对原生opa，省掉的步骤有两个，不用在去手动注册webhook了；并且由于可以通过CRD动态修改规则，因此不需要再手动启动一个service去挂bundle供下载。<br>可以看到已经自动注册了一个webhoook：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ kl get ValidatingWebhookConfiguration</span><br><span class="line">NAME                                          WEBHOOKS   AGE</span><br><span class="line">gatekeeper-validating-webhook-configuration   2          5m36s</span><br><span class="line">ingress-nginx-admission                       1          4d5h</span><br></pre></td></tr></table></figure>

<p>还可以看到原先的ns不满足约束：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ kl get K8sRequiredLabels  -ojsonpath=&#x27;&#123;.items[*].status.violations&#125;&#x27; | jq</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;enforcementAction&quot;: &quot;deny&quot;,</span><br><span class="line">    &quot;kind&quot;: &quot;Namespace&quot;,</span><br><span class="line">    &quot;message&quot;: &quot;you must provide labels: &#123;\&quot;owner\&quot;, \&quot;usage\&quot;&#125;&quot;,</span><br><span class="line">    &quot;name&quot;: &quot;kube-system&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">	......</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<h2 id="AppArmor"><a href="#AppArmor" class="headerlink" title="AppArmor"></a>AppArmor</h2><p>AppArmor配置一个程序拥有的权限，能做的事，不能做的事。 </p>
<p>要能起作用，必须是内核打开了开关，同时要预先加载你想要的profile。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://kubernetes.io/docs/tutorials/clusters/apparmor/ </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># check if kernel support enabled</span><br><span class="line"></span><br><span class="line">~$ cat /sys/module/apparmor/parameters/enabled</span><br><span class="line">Y</span><br><span class="line"></span><br><span class="line"># 或者</span><br><span class="line">~$ kubectl get nodes -o=jsonpath=$&#x27;&#123;range .items[*]&#125;&#123;@.metadata.name&#125;: &#123;.status.conditions[?(@.reason==&quot;KubeletReady&quot;)].message&#125;\n&#123;end&#125;&#x27;</span><br><span class="line">server1: kubelet is posting ready status. AppArmor enabled</span><br><span class="line">server2: kubelet is posting ready status. AppArmor enabled</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># check profile already loaded</span><br><span class="line"># profile在这里就是指的一个apparmor规则文件</span><br><span class="line"></span><br><span class="line">~$ sudo cat /sys/kernel/security/apparmor/profiles</span><br><span class="line">cri-containerd.apparmor.d (enforce)</span><br><span class="line">/snap/snapd/13269/usr/lib/snapd/snap-confine (enforce)</span><br><span class="line">/snap/snapd/13269/usr/lib/snapd/snap-confine//mount-namespace-capture-helper (enforce)</span><br><span class="line">snap.lxd.lxd (enforce)</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 或者</span><br><span class="line">~$ sudo apparmor_status</span><br><span class="line">apparmor module is loaded.</span><br><span class="line">32 profiles are loaded.</span><br><span class="line">32 profiles are in enforce mode.</span><br><span class="line">   /snap/snapd/13269/usr/lib/snapd/snap-confine</span><br><span class="line">   /snap/snapd/13269/usr/lib/snapd/snap-confine//mount-namespace-capture-helper</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># how to load profile</span><br><span class="line">加载profile可以把profile放到/etc/apparmor.d/下开机自动加载,</span><br><span class="line">或者执行apparmor_parser filename手动每次加载。</span><br><span class="line"></span><br><span class="line"># how to unload profile</span><br><span class="line">apparmor_parser -R filename</span><br></pre></td></tr></table></figure>

<p>apparmor的配置方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">第一种配置方式是通过在pod的annotations中添加配置来实现的。</span><br><span class="line">  annotations:</span><br><span class="line">    container.apparmor.security.beta.kubernetes.io/containerName: xxxx</span><br><span class="line">    </span><br><span class="line">containerName是实际的容器的name；xxxx这里支持3种值。</span><br><span class="line">1. runtime/default，默认的profile。</span><br><span class="line">	和留空不配annotation是等价的（在启动了apparmor和没在psp配置apparmor的情况下）。</span><br><span class="line">2. localhost/&lt;profile_name&gt;， 就是加载本机的apparmor规则。</span><br><span class="line">3. unconfined， 不应用任何apparmor规则。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">第二种配置方式是在psp中配置，psp我们前面已经介绍过。</span><br><span class="line">如果PSP启动了，那么可以在psp中配置全局的apparmor，影响范围是psp被pod选中的时候的那些pod。</span><br><span class="line">可以在psp中配置annotations：</span><br><span class="line">apparmor.security.beta.kubernetes.io/defaultProfileName: &lt;profile_ref&gt;</span><br><span class="line">apparmor.security.beta.kubernetes.io/allowedProfileNames: &lt;profile_ref&gt;[,others...]</span><br><span class="line"></span><br><span class="line">defaultProfileName是没有配置apparmor的时候默认应用的profile。</span><br><span class="line">allowedProfileNames是pod中允许使用的profile。</span><br><span class="line">如果default和allowed都配了，allowed必须包含default这个profile。</span><br><span class="line">The default profile name option specifies the profile to apply to containers by default when none is specified. The allowed profile names option specifies a list of profiles that Pod containers are allowed to be run with. If both options are provided, the default must be allowed.</span><br></pre></td></tr></table></figure>

<p>使用举例, 创建一个应用了apparmor的pod：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"># create yaml</span><br><span class="line">~$ vi busyapparmor.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: busy1</span><br><span class="line">  name: busy1</span><br><span class="line">  annotations:</span><br><span class="line">    container.apparmor.security.beta.kubernetes.io/busy1: localhost/k8s-apparmor-example-deny-write</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: busybox</span><br><span class="line">    name: busy1</span><br><span class="line">    command:</span><br><span class="line">    - sh</span><br><span class="line">    - -c</span><br><span class="line">    - &quot;echo &#x27;AABBCC&#x27; &amp;&amp; sleep 1h&quot;</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Never</span><br><span class="line">status: &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># apply yaml</span><br><span class="line">~$ kl apply -f busyapparmor.yaml </span><br><span class="line">pod/busy1 created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># check pod status</span><br><span class="line">~$ kl get pod</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE</span><br><span class="line">busy1       0/1     Blocked   0          50s</span><br><span class="line">可以看到pod的状态是Blocked,并且可以从message看到错误信息：</span><br><span class="line">~$ kl get pod busy1 -o jsonpath=&#x27;&#123;.status.message&#125;&#x27;</span><br><span class="line">Cannot enforce AppArmor: profile &quot;k8s-apparmor-example-deny-write&quot; is not loaded</span><br><span class="line"></span><br><span class="line">可以看到因为profile没有加载，所以pod无法成功启动。</span><br><span class="line">现在我们要做的是在server2中加载profile，然后给server2配置label，然后给pod配置nodeSelector,这样就可以确保pod被加载到server2中.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">~$ vi deny_write.profile</span><br><span class="line">#include &lt;tunables/global&gt;</span><br><span class="line"></span><br><span class="line">profile k8s-apparmor-example-deny-write flags=(attach_disconnected) &#123;</span><br><span class="line">  #include &lt;abstractions/base&gt;</span><br><span class="line"></span><br><span class="line">  file,</span><br><span class="line"></span><br><span class="line">  # Deny all file writes.</span><br><span class="line">  deny /** w,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">~$ sudo apparmor_parser deny_write.profile</span><br><span class="line">~$ kl label node server2 profile=k8s-apparmor-example-deny-write</span><br><span class="line">node/server2 labeled</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">~$ vi busyapparmor.yaml</span><br><span class="line"># 添加nodeSelecctor</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: busy1</span><br><span class="line">  name: busy1</span><br><span class="line">  annotations:</span><br><span class="line">    container.apparmor.security.beta.kubernetes.io/busy1: localhost/k8s-apparmor-example-deny-write</span><br><span class="line">spec:</span><br><span class="line">  nodeSelector:</span><br><span class="line">    profile: k8s-apparmor-example-deny-write</span><br><span class="line">  containers:</span><br><span class="line">  - image: busybox</span><br><span class="line">    name: busy1</span><br><span class="line">    command:</span><br><span class="line">    - sh</span><br><span class="line">    - -c</span><br><span class="line">    - &quot;echo &#x27;AABBCC&#x27; &amp;&amp; sleep 1h&quot;</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Never</span><br><span class="line">status: &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">~$ kl apply -f busyapparmor.yaml --force</span><br><span class="line">pod/busy1 configured</span><br><span class="line"></span><br><span class="line"># 重新查看pod的状态</span><br><span class="line">~$ kl get pod -owide</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE   IP              NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">busy1       1/1     Running   0          21s   10.244.192.10   server2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">可以看到pod已经成功在server2上面执行了。</span><br><span class="line">通过执行下面命令可以doubel check加载profile成功了。</span><br><span class="line">~$ kl exec busy1 -- cat /proc/1/attr/current</span><br><span class="line">k8s-apparmor-example-deny-write (enforce)</span><br></pre></td></tr></table></figure>



<h2 id="IAM-Identity-and-Access-Management"><a href="#IAM-Identity-and-Access-Management" class="headerlink" title="IAM(Identity and Access Management)"></a>IAM(Identity and Access Management)</h2><p>介绍k8s中认证方面的一些知识，考试不会直接考到，就是属于了解一下k8s的知识。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># 资料</span><br><span class="line">https://kubernetes.io/docs/reference/access-authn-authz/authentication/</span><br><span class="line">https://kubernetes.io/docs/tasks/extend-kubernetes/configure-aggregation-layer/#authentication-flow</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 用户类型</span><br><span class="line">All Kubernetes clusters have two categories of users: service accounts managed by Kubernetes, and normal users.</span><br><span class="line">SA是在k8s集群内部管理的，user是外部管理的。</span><br><span class="line"></span><br><span class="line"># 认证方式</span><br><span class="line">我现在只知道X509 cert client/service account/openid connect(OIDC)这几个认证方式。</span><br><span class="line">除了sa，其他的都属于user。</span><br><span class="line"></span><br><span class="line"># 认证形式</span><br><span class="line">而认证形式我知道的包括X509 cert client/token(包括static token,bootstrap token,sa token,openid token)/aggregator proxy</span><br><span class="line">Kubernetes uses client certificates, bearer tokens, or an authenticating proxy to authenticate API requests through authentication plugins。</span><br><span class="line"></span><br><span class="line"># aggregator proxy(集合层)的实现机制</span><br><span class="line">aggregator proxy是在apiserver实现的一个扩展机制，允许它把请求转发给另一个服务。</span><br><span class="line">从角色上来说包含apiserver handler和extension server handler两个， apiserver handler会把部分请求转发给extension server，这个extension server有自己的CA，在apiserver handler转发给extension的时候会使用对应的client cert，</span><br><span class="line">同时在http header中带上客户端的用户名等信息，这样extension就不需要再验证一遍了。</span><br><span class="line">转发的时候用到了apiserver的这几个参数</span><br><span class="line">- --requestheader-allowed-names=front-proxy-client # 证书中的CN</span><br><span class="line">- --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt</span><br><span class="line">- --requestheader-extra-headers-prefix=X-Remote-Extra-</span><br><span class="line">- --requestheader-group-headers=X-Remote-Group</span><br><span class="line">- --requestheader-username-headers=X-Remote-User</span><br><span class="line">所谓的proxy机制也就是extension server通过requestheader-client-ca-file这个独立的ca文件验证proxy(apiserver自己)的身份，随后信任proxy。</span><br><span class="line">信任之后通过proxy携带的相关username等信息组合出用户的完整信息。这个机制用来扩展apiserver的功能，扩展功能都放在extension server。</span><br></pre></td></tr></table></figure>

<h3 id="aggregator-proxy-集合层"><a href="#aggregator-proxy-集合层" class="headerlink" title="aggregator proxy(集合层)"></a>aggregator proxy(集合层)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://kubernetes.io/docs/tasks/extend-kubernetes/configure-aggregation-layer/</span><br><span class="line">https://itnext.io/our-journey-in-building-a-kubernetes-aggregated-api-server-29a4f9c1de22</span><br></pre></td></tr></table></figure>

<p>集合层的机制上面提了，关于他的流程我们可以了解一下，他是apiserver实现的一个扩展机制。</p>
<p>整个流程中涉及两个角色apiserver和extension server，为了同官方文档对应，我们叫他们aggregator以及aggregated。其中aggregated负责扩展某个功能。类比一下，就是aggregator监听某个路径下的请求，然后将它转发给aggregated，aggregated也就是一个扩展服务器。</p>
<p>aggregated首先会将自己注册到aggregator上去，aggregator收到用户请求后先对请求进行认证和授权，认证流程跟正常一样，授权流程这里暂时只是检查有没有对这个路径的访问权限，路径则关联功能。然后aggregator把请求转发给aggregated，aggregated收到请求后，同样要经过认证和授权两个步骤。</p>
<p>认证是使用证书的方式进行安全验证，aggregator需要携带证书来请求aggregated。授权则是从请求的http header中取出用户名用户组等信息，由于经过了认证，所以这里对于取出的header中信息的真实性就可以直接信任了，aggregated然后根据获取到的用户信息发送SujectAccessReview给aggregator进行授权，这里授权的则是这个用户有没有操作某个资源的权限，而不是刚才检查是否有路径的访问权限。授权通过的话就可以执行具体的业务。</p>
<p>整个流程如图：</p>
<p><img src="/linkimage/cksknowledge/aggregation-api-auth-flow.png" alt="aggregation-api-auth-flow"></p>
<p>图片来自<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/extend-kubernetes/configure-aggregation-layer/">Authentication Flow</a></p>
<p>我们可以看到aggregated就是一个独立的服务，用来扩展apiserver，它只是把前期的认证阶段交给了原来的apiserver来做。</p>
<h2 id="runtime-class"><a href="#runtime-class" class="headerlink" title="runtime class"></a>runtime class</h2><p>说到容器运行时，我们会想到docker，containerd，cri-o, 同时你也可能想到runc，gvisor，事实上，这几个都叫容器运行时，但是前者又是可以调用后者的，这就比较让人困惑了。所以通常来说，前者（docker，containerd，cri-o）我们叫它上层容器运行时（high-level container runtimes），后者（runc，gvisor）我们叫它底层容器运行时（low-level container runtimes）。如图：</p>
<p><img src="/linkimage/cksknowledge/high_low_container_runtime.png" alt="high-low-container-runtime"></p>
<p>图片来自<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/338036211">一文看懂 Container Runtime</a></p>
<p>k8s支持使用指定的底层容器运行时，可以为某个pod指定是使用runc还是使用gvisor。要达到这个目的，首先要让上层容器运行时支持指定的底层容器运行时，这一步通过在主机中安装相应底层容器运行时，以及配置上层容器运行时来接入该底层运行时，来完成；另外就是需要在k8s中为指定的底层容器运行时创建对应的RuntimeClass资源（k8s中默认是没有RuntimeClass实例的，意味着默认是使用默认的底层运行时）。</p>
<p>以接入新的底层运行时gvisor为例，我们可以这么做：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">首先安装另一个实现gvisor：</span><br><span class="line"># https://gvisor.dev/docs/user_guide/install/</span><br><span class="line"></span><br><span class="line">~$ vi installgvisor.sh</span><br><span class="line">(</span><br><span class="line">  set -e</span><br><span class="line">  ARCH=$(uname -m)</span><br><span class="line">  URL=https://storage.googleapis.com/gvisor/releases/release/latest/$&#123;ARCH&#125;</span><br><span class="line">  wget $&#123;URL&#125;/runsc $&#123;URL&#125;/runsc.sha512 \</span><br><span class="line">    $&#123;URL&#125;/containerd-shim-runsc-v1 $&#123;URL&#125;/containerd-shim-runsc-v1.sha512</span><br><span class="line">  sha512sum -c runsc.sha512 \</span><br><span class="line">    -c containerd-shim-runsc-v1.sha512</span><br><span class="line">  rm -f *.sha512</span><br><span class="line">  chmod a+rx runsc containerd-shim-runsc-v1</span><br><span class="line">  sudo mv runsc containerd-shim-runsc-v1 /usr/local/bin</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">~$ chmod +x installgvisor.sh</span><br><span class="line">~$ ./installgvisor.sh</span><br><span class="line">......</span><br><span class="line">Total wall clock time: 38s</span><br><span class="line">Downloaded: 4 files, 57M in 35s (1.61 MB/s)</span><br><span class="line">runsc: OK</span><br><span class="line">containerd-shim-runsc-v1: OK</span><br></pre></td></tr></table></figure>

<p>然后配置containerd的配置文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">修改配置文件（不同的容器运行时使用不同的配置文件），containerd就是修改/etc/containerd/config.toml,其他运行时的修改可以参考文档：</span><br><span class="line">https://kubernetes.io/docs/concepts/containers/runtime-class/</span><br><span class="line"></span><br><span class="line">~$ sudo vi /etc/containerd/config.toml</span><br><span class="line"># 插入两行</span><br><span class="line">#     [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runsc]</span><br><span class="line">#       runtime_type = &quot;io.containerd.runsc.v1&quot;</span><br><span class="line">......</span><br><span class="line">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.default_runtime]</span><br><span class="line">        base_runtime_spec = &quot;&quot;</span><br><span class="line">        container_annotations = []</span><br><span class="line">        pod_annotations = []</span><br><span class="line">        privileged_without_host_devices = false</span><br><span class="line">        runtime_engine = &quot;&quot;</span><br><span class="line">        runtime_root = &quot;&quot;</span><br><span class="line">        runtime_type = &quot;&quot;</span><br><span class="line"></span><br><span class="line">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.default_runtime.options]</span><br><span class="line"></span><br><span class="line">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runsc]</span><br><span class="line">        runtime_type = &quot;io.containerd.runsc.v1&quot;</span><br><span class="line">      </span><br><span class="line">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes]</span><br><span class="line"></span><br><span class="line">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc]</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 然后重启containerd</span><br><span class="line">~$ sudo systemctl daemon-reload</span><br><span class="line">~$ sudo systemctl restart containerd</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后创建Runtime Class</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~$ vi runtimeclass.yaml</span><br><span class="line">apiVersion: node.k8s.io/v1</span><br><span class="line">kind: RuntimeClass</span><br><span class="line">metadata:</span><br><span class="line">  name: myclass  </span><br><span class="line">handler: runsc</span><br><span class="line"># 注意这里的runsc需要和/etc/containerd/config.toml中runtimes的配置对应的名字一样。</span><br><span class="line">如果写的不对，这里不会报错，到最后用到的时候才会报错，导致pod启动失败。</span><br><span class="line"></span><br><span class="line"># 然后apply</span><br><span class="line">~$ kl apply -f runtimeclass.yaml </span><br><span class="line">runtimeclass.node.k8s.io/myclass created</span><br></pre></td></tr></table></figure>

<p>然后在pod中使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">~$ vi ng.yaml</span><br><span class="line"># 注意nodeName和runtimeClassName两个字段</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    run: ng</span><br><span class="line">  name: ng</span><br><span class="line">spec:</span><br><span class="line">  nodeName: server2</span><br><span class="line">  runtimeClassName: myclass</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    name: ng</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">status: &#123;&#125;</span><br><span class="line"></span><br><span class="line">~$ kl apply -f ng.yaml</span><br><span class="line">pod/ng created</span><br><span class="line"></span><br><span class="line">如果我们没有指定nodeName，然后pod又正好调度到了没有安装runsc的节点，那么pod会启动失败，并可以通过event看到提示：</span><br><span class="line">~$ kl get event</span><br><span class="line">LAST SEEN   TYPE      REASON                   OBJECT          MESSAGE</span><br><span class="line">3s          Warning   FailedCreatePodSandBox   pod/ng          Failed to create pod sandbox: rpc error: code = Unknown desc = failed to get sandbox runtime: no runtime for &quot;runsc&quot; is configured</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">那么如何确认这个pod是使用了runsc呢？</span><br><span class="line">可以进到pod中执行dmesg看到gVisor相关信息，就表示成功了。</span><br><span class="line">~$ kl exec ng -- dmesg</span><br><span class="line">[    0.000000] Starting gVisor...</span><br><span class="line">[    0.171422] Searching for needles in stacks...</span><br><span class="line">[    0.467189] Recruiting cron-ies...</span><br><span class="line">[    0.859775] Letting the watchdogs out...</span><br><span class="line">[    1.044028] Forking spaghetti code...</span><br><span class="line">[    1.165573] Searching for socket adapter...</span><br><span class="line">[    1.559524] Checking naughty and nice process list...</span><br><span class="line">[    2.035042] Singleplexing /dev/ptmx...</span><br><span class="line">[    2.493387] Reticulating splines...</span><br><span class="line">[    2.965587] Generating random numbers by fair dice roll...</span><br><span class="line">[    3.362163] Checking naughty and nice process list...</span><br><span class="line">[    3.821549] Setting up VFS2...</span><br><span class="line">[    3.868035] Ready!</span><br></pre></td></tr></table></figure>



<h2 id="缩小镜像"><a href="#缩小镜像" class="headerlink" title="缩小镜像"></a>缩小镜像</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">https://learnk8s.io/blog/smaller-docker-images</span><br><span class="line">有几个招数：</span><br><span class="line">1. 把RUN的指令合成一条，减少layer数</span><br><span class="line">2. 分步build，前一步可以很大用来build最终文件；然后把最终文件copy到第二个做种的基础镜像。</span><br><span class="line">3. 使用小镜像distroless（这个需要外网才能拉取到）</span><br><span class="line">4. 使用alpine镜像，这个比distroless还小，而且还会携带sh，便于调试；但有个缺点是可能存在兼容性问题，同时安全性方面提供shell也是一个缺点。</span><br><span class="line"></span><br><span class="line">比如几种镜像的大小：</span><br><span class="line">Image	Size (MB)</span><br><span class="line">node:8	681</span><br><span class="line">node:8 with multi stage build	678</span><br><span class="line">gcr.io/distroless/nodejs	76.7</span><br><span class="line">node:8-alpine	69.7</span><br></pre></td></tr></table></figure>



<h2 id="pod优雅终止流程"><a href="#pod优雅终止流程" class="headerlink" title="pod优雅终止流程"></a>pod优雅终止流程</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">https://cloud.google.com/blog/products/containers-kubernetes/kubernetes-best-practices-terminating-with-grace</span><br><span class="line">https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/</span><br><span class="line"></span><br><span class="line">1. 状态设为Terminating</span><br><span class="line">	这是一个流量挡板，不再接受新的流量，pod也会从svc的endpoints list移除。</span><br><span class="line">2. 发送用户自定义的preStop请求，场景是用户无法控制SIGTERM的回调逻辑。</span><br><span class="line">	 随后发送SIGTERM给进程，通知退出。所以preStop最好不要阻塞，以免SIGTERM发不出来。</span><br><span class="line">3. 集群等待terminationGracePeriodSeconds直到进程退出或者超时。</span><br><span class="line">	preStop和SIGTERM引发的异步退出是并行的，所以等待是同时等待他们两个。</span><br><span class="line">	terminationGracePeriodSeconds的时间是在发送preStop之前的某个时间就开始了的。</span><br><span class="line">4. 发送SIGKILL给进程，也就是kill -9, 强制结束进程，清除容器。</span><br><span class="line">5. 从apiserver中清理掉pod。</span><br></pre></td></tr></table></figure>



<h2 id="log-place"><a href="#log-place" class="headerlink" title="log place"></a>log place</h2><p>几个存储日志的地方，特别是有时候apiserver异常，想看apiserver的日志的时候，没法通过kubectl查看。这时候可以直接到那个目录去看日志。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">https://itnext.io/cks-exam-series-4-crash-that-apiserver-5f4d3d503028</span><br><span class="line"></span><br><span class="line">Log locations to check:</span><br><span class="line">/var/log/pods  # pod的日志, apiserver连不上时可以尝试从这里查看日志</span><br><span class="line">/var/log/containers  # container的日志, 这里的log软连接到pods目录下</span><br><span class="line">docker ps + docker logs</span><br><span class="line">crictl ps + crictl logs (in case when Docker isn’t used)</span><br><span class="line">kubelet logs: /var/log/syslog or journalctl -u kubelet # 这两个好像是一样的</span><br></pre></td></tr></table></figure>



<h2 id="ImagePolicyWebhook"><a href="#ImagePolicyWebhook" class="headerlink" title="ImagePolicyWebhook"></a>ImagePolicyWebhook</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">资料：</span><br><span class="line">https://github.com/killer-sh/cks-challenge-series/tree/master/challenges/ImagePolicyWebhook</span><br><span class="line">https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#imagepolicywebhook</span><br></pre></td></tr></table></figure>

<p>ImagePolicyWebhook也是admission-control中的一个插件，需要通过apiserver的参数–enable-admission-plugins开启，并需要在–admission-control-config-file指定的文件中插入相关配置。</p>
<p>ImagePolicyWebhook的作用是通过webhook来检查这个image是否被允许。他需要配置几个功能相关的字段，同时需要配置相关的证书文件。</p>
<p>我们一步一步来完成配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1. 添加ImagePolicyWebhook插件</span></span><br><span class="line"><span class="meta">/etc/kubernetes/admission$</span><span class="bash"> sudo vi admission-control-config-file.yaml</span></span><br><span class="line">...</span><br><span class="line">- name: ImagePolicyWebhook</span><br><span class="line">  path: image-policy.yaml</span><br><span class="line">...</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 添加image-policy.yaml文件</span></span><br><span class="line"><span class="meta">/etc/kubernetes/admission$</span><span class="bash"> sudo vi image-policy.yaml</span></span><br><span class="line">imagePolicy:</span><br><span class="line">  kubeConfigFile: /etc/kubernetes/admission/image-kubeconf.yaml</span><br><span class="line"><span class="meta">  #</span><span class="bash"> time <span class="keyword">in</span> s to cache approval</span></span><br><span class="line">  allowTTL: 50</span><br><span class="line"><span class="meta">  #</span><span class="bash"> time <span class="keyword">in</span> s to cache denial</span></span><br><span class="line">  denyTTL: 50</span><br><span class="line"><span class="meta">  #</span><span class="bash"> time <span class="keyword">in</span> ms to <span class="built_in">wait</span> between retries</span></span><br><span class="line">  retryBackoff: 500</span><br><span class="line"><span class="meta">  #</span><span class="bash"> determines behavior <span class="keyword">if</span> the webhook backend fails</span></span><br><span class="line">  defaultAllow: false</span><br><span class="line"><span class="meta">  </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 添加image-kubeconf.yaml文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ImagePolicyWebhook是通过kubeconfig格式的文件来配置对外部的访问。</span></span><br><span class="line"><span class="meta">/etc/kubernetes/admission$</span><span class="bash"> sudo vi image-kubeconf.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Config</span><br><span class="line"></span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority: /etc/kubernetes/admission/imagecert/external-cert.pem</span><br><span class="line">    server: https://external-service:1234/check-image</span><br><span class="line">  name: image-checker</span><br><span class="line"></span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: image-checker</span><br><span class="line">    user: api-server</span><br><span class="line">  name: image-checker</span><br><span class="line">current-context: image-checker</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line"></span><br><span class="line">users:</span><br><span class="line">- name: api-server</span><br><span class="line">  user:</span><br><span class="line">    client-certificate: /etc/kubernetes/admission/imagecert/apiserver-client-cert.pem     # cert for the webhook admission controller to use</span><br><span class="line">    client-key:  /etc/kubernetes/admission/imagecert/apiserver-client-key.pem</span><br><span class="line">    </span><br><span class="line">这里我们设置一个不存在的server地址，因为没有这样的server用来测试。</span><br><span class="line">然后指定了client-certificate和client-key作为客户端的证书，指定certificate-authority作为外部服务的CA证书。</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. 创建证书文件。</span></span><br><span class="line"><span class="meta">/etc/kubernetes/admission$</span><span class="bash"> sudo mkdir imagecert</span></span><br><span class="line"><span class="meta">/etc/kubernetes/admission$</span><span class="bash"> <span class="built_in">cd</span> imagecert/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 我们借助现成的一套证书来做测试</span></span><br><span class="line"><span class="meta">/etc/kubernetes/admission/imagecert$</span><span class="bash"> sudo wget https://github.com/killer-sh/cks-challenge-series/archive/refs/heads/master.zip -O /tmp/resource.zip</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ......</span></span><br><span class="line"><span class="meta">/etc/kubernetes/admission/imagecert$</span><span class="bash"> unzip /tmp/resource.zip -d /tmp</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ......</span></span><br><span class="line"><span class="meta">/etc/kubernetes/admission/imagecert$</span><span class="bash"> sudo cp /tmp/cks-challenge-series-master/challenges/ImagePolicyWebhook/*.pem ./</span></span><br><span class="line"><span class="meta">/etc/kubernetes/admission/imagecert$</span><span class="bash"> ls</span></span><br><span class="line">apiserver-client-cert.pem  apiserver-client-key.pem  external-cert.pem  external-key.pem</span><br><span class="line"><span class="meta">/etc/kubernetes/admission/imagecert$</span><span class="bash"> ls ..</span></span><br><span class="line">admission-control-config-file.yaml  image-kubeconf.yaml  imagecert</span><br><span class="line">eventconfig.yaml                    image-policy.yaml</span><br><span class="line"><span class="meta">#</span><span class="bash"> eventconfig.yaml是另一个插件配置了EventRateLimit</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 5. 开启ImagePolicyWebhook开关</span></span><br><span class="line"><span class="meta">/etc/kubernetes/admission/imagecert$</span><span class="bash"> sudo vi ../../manifests/kube-apiserver.yaml</span></span><br><span class="line">...</span><br><span class="line">  - --enable-admission-plugins=NodeRestriction,PodSecurityPolicy,EventRateLimit,ImagePolicyWebhook</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>等待apiserver重启完成，我们来测试创建pod，由于外部服务不可达，所以我们的pod会一直无法创建成功。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ kl run ng1 --image nginx</span><br><span class="line">Error from server (Forbidden): pods &quot;ng1&quot; is forbidden: Post &quot;https://external-service:1234/check-image?timeout=30s&quot;: dial tcp: lookup external-service on 192.168.3.1:53: no such host</span><br></pre></td></tr></table></figure>



<p>随后我们编辑image-policy.yaml，把其中defaultAllow设成true。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/etc/kubernetes/admission$ sudo vi image-policy.yaml</span><br><span class="line">imagePolicy:</span><br><span class="line">  kubeConfigFile: /etc/kubernetes/admission/image-kubeconf.yaml</span><br><span class="line">  # time in s to cache approval</span><br><span class="line">  allowTTL: 50</span><br><span class="line">  # time in s to cache denial</span><br><span class="line">  denyTTL: 50</span><br><span class="line">  # time in ms to wait between retries</span><br><span class="line">  retryBackoff: 500</span><br><span class="line">  # determines behavior if the webhook backend fails</span><br><span class="line">  defaultAllow: true</span><br></pre></td></tr></table></figure>

<p>然后重启apiserver。我们再次执行创建pod，发现可以创建成功了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ kl run ng1 --image nginx</span><br><span class="line">pod/ng1 created</span><br></pre></td></tr></table></figure>

<h2 id="immutable-pod-stateless-pod"><a href="#immutable-pod-stateless-pod" class="headerlink" title="immutable pod &#x2F; stateless pod"></a>immutable pod &#x2F; stateless pod</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">immutable主要是指pod不能修改主机文件</span><br><span class="line">security context中的readOnlyRootFilesystem以及privileged都得是false。</span><br><span class="line"></span><br><span class="line">stateles主要是不能存数据在container中，emptyDir的volume也不行。</span><br></pre></td></tr></table></figure>



<h2 id="kubesec"><a href="#kubesec" class="headerlink" title="kubesec"></a>kubesec</h2><p>kubesec是一个静态扫描的工具，扫描一个yaml文件存在的安全隐患。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">文档：</span><br><span class="line">https://github.com/controlplaneio/kubesec</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">install</span></span><br><span class="line">go install github.com/controlplaneio/kubesec/v2@latest</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">then</span></span></span><br><span class="line">kl run ngsec --image nginx --restart=Never --dry-run=client -oyaml &gt; ngsec.yaml</span><br><span class="line">kubesec scan ngsec.yaml</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 我们也可以使用他的免安装版：</span></span><br><span class="line"><span class="meta">~$</span><span class="bash"> kl run ngsec --image nginx --restart=Never --dry-run=client -oyaml &gt; ngsec.yaml</span></span><br><span class="line"><span class="meta">~$</span><span class="bash"> curl -sSX POST --data-binary @<span class="string">&quot;ngsec.yaml&quot;</span> https://v2.kubesec.io/scan</span></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;object&quot;: &quot;Pod/ngsec.default&quot;,</span><br><span class="line">    &quot;valid&quot;: true,</span><br><span class="line">    &quot;fileName&quot;: &quot;API&quot;,</span><br><span class="line">    &quot;message&quot;: &quot;Passed with a score of 0 points&quot;,</span><br><span class="line">    &quot;score&quot;: 0,</span><br><span class="line">    &quot;scoring&quot;: &#123;</span><br><span class="line">      &quot;advise&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;id&quot;: &quot;ApparmorAny&quot;,</span><br><span class="line">          &quot;selector&quot;: &quot;.metadata .annotations .\&quot;container.apparmor.security.beta.kubernetes.io/nginx\&quot;&quot;,</span><br><span class="line">          &quot;reason&quot;: &quot;Well defined AppArmor policies may provide greater protection from unknown threats. WARNING: NOT PRODUCTION READY&quot;,</span><br><span class="line">          &quot;points&quot;: 3</span><br><span class="line">        &#125;,</span><br><span class="line">        ......</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<h2 id="trivy"><a href="#trivy" class="headerlink" title="trivy"></a>trivy</h2><p>静态扫描镜像的安全风险。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"># install</span><br><span class="line">https://aquasecurity.github.io/trivy/v0.22.0/getting-started/installation/</span><br><span class="line"># 注意，trivy不存在我所使用的树莓派的系统的源，所以用apt的方式拉不到</span><br><span class="line"># 尝试用源码编译，却遇到网络问题，所以我放弃在树莓派上的安装。改在自己的pc上安装，因为这个就是一个静态扫描的，并不依赖集群，所以随便装到一个能装上的机器就可以了。</span><br><span class="line"></span><br><span class="line"># 使用方法：</span><br><span class="line"># https://github.com/aquasecurity/trivy</span><br><span class="line"># 比如扫描镜像yizhiren/opa:0.35.0-rootless</span><br><span class="line">% trivy image yizhiren/opa:0.35.0-rootless</span><br><span class="line">2022-01-08T12:38:44.803+0800	INFO	Detected OS: ubuntu</span><br><span class="line">2022-01-08T12:38:44.805+0800	INFO	Detecting Ubuntu vulnerabilities...</span><br><span class="line">2022-01-08T12:38:44.812+0800	INFO	Number of language-specific files: 1</span><br><span class="line">2022-01-08T12:38:44.812+0800	INFO	Detecting gobinary vulnerabilities...</span><br><span class="line"></span><br><span class="line">yizhiren/opa:0.35.0-rootless (ubuntu 21.10)</span><br><span class="line">===========================================</span><br><span class="line">Total: 21 (UNKNOWN: 0, LOW: 18, MEDIUM: 3, HIGH: 0, CRITICAL: 0)</span><br><span class="line"></span><br><span class="line">+------------------+------------------+----------+-----------------------+---------------+-----------------------------------------+</span><br><span class="line">|     LIBRARY      | VULNERABILITY ID | SEVERITY |   INSTALLED VERSION   | FIXED VERSION |                  TITLE                  |</span><br><span class="line">+------------------+------------------+----------+-----------------------+---------------+-----------------------------------------+</span><br><span class="line">| coreutils        | CVE-2016-2781    | LOW      | 8.32-4ubuntu2         |               | coreutils: Non-privileged               |</span><br><span class="line">|                  |                  |          |                       |               | session can escape to the               |</span><br><span class="line">|                  |                  |          |                       |               | parent session in chroot                |</span><br><span class="line">|                  |                  |          |                       |               | --&gt;avd.aquasec.com/nvd/cve-2016-2781    |</span><br><span class="line">+------------------+------------------+----------+-----------------------+---------------+-----------------------------------------+</span><br><span class="line">| libc-bin         | CVE-2021-38604   | MEDIUM   | 2.34-0ubuntu3         |               | glibc: NULL pointer dereference in      |</span><br><span class="line">|                  |                  |          |                       |               | helper_thread() in mq_notify.c while    |</span><br><span class="line">|                  |                  |          |                       |               | handling NOTIFY_REMOVED messages...     |</span><br><span class="line">|                  |                  |          |                       |               | --&gt;avd.aquasec.com/nvd/cve-2021-38604   |</span><br><span class="line">+                  +------------------+----------+                       +---------------+-----------------------------------------+</span><br><span class="line">|                  | CVE-2016-10228   | LOW      |                       |               | glibc: iconv program can hang           |</span><br><span class="line">|                  |                  |          |                       |               | when invoked with the -c option         |</span><br><span class="line">|                  |                  |          |                       |               | --&gt;avd.aquasec.com/nvd/cve-2016-10228   |</span><br><span class="line">+                  +------------------+          +                       +---------------+-----------------------------------------+</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">可以看到列出了安全风险以及风险级别。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">trivy还支持fs和config子命令，考试只会考到trivy image，但是其他两个子命令也有实用价值。</span><br><span class="line">fs会扫描目录下的所有文件，检查其中的引入的风险点，包括镜像名，库名，某个字段。</span><br><span class="line">config则只会扫描目录下文件中的字段。</span><br><span class="line">github主页中都有列举：https://github.com/aquasecurity/trivy#quick-start</span><br></pre></td></tr></table></figure>





<h2 id="anchore-syft"><a href="#anchore-syft" class="headerlink" title="anchore&#x2F;syft"></a>anchore&#x2F;syft</h2><p>syft也是静态扫描工具，可以列出image中的软件清单</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/anchore/syft </span><br><span class="line"></span><br><span class="line"># install</span><br><span class="line">curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin</span><br><span class="line">如果网络问题，可以先把install.sh内容去保存下来，然后cat install.sh | sh -s -- -b /usr/local/bin latest</span><br><span class="line">如果还是有网络问题，立即换到网络通畅的机器上，这个反正是静态工具，不依赖集群的。</span><br><span class="line"></span><br><span class="line"># usage</span><br><span class="line">% syft yizhiren/opa:0.35.0-rootless</span><br><span class="line"></span><br><span class="line"> ✔ Pulled image            </span><br><span class="line"> ✔ Loaded image            </span><br><span class="line"> ✔ Parsed image            </span><br><span class="line"> ✔ Cataloged packages      [101 packages]</span><br><span class="line">NAME                 VERSION                             TYPE </span><br><span class="line">adduser              3.118ubuntu5                        deb   </span><br><span class="line">apt                  2.3.9                               deb   </span><br><span class="line">base-files           11.1ubuntu5                         deb   </span><br><span class="line">base-passwd          3.5.51                              deb   </span><br><span class="line">bash                 5.1-3ubuntu2                        deb   </span><br><span class="line">bsdutils             1:2.36.1-8ubuntu2                   deb   </span><br><span class="line">coreutils            8.32-4ubuntu2                       deb   </span><br><span class="line">dash                 0.5.11+git20210120+802ebd4-1build1  deb   </span><br><span class="line">debconf              1.5.77                              deb</span><br><span class="line">......</span><br></pre></td></tr></table></figure>



<h2 id="anchore-grype"><a href="#anchore-grype" class="headerlink" title="anchore&#x2F;grype"></a>anchore&#x2F;grype</h2><p>grype也是安全检查用的，跟trivy是一样的作用。grype内部依赖syft的列清单功能。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/anchore/grype</span><br><span class="line"></span><br><span class="line"># install</span><br><span class="line">curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin</span><br><span class="line">如果网络问题，可以先把install.sh内容去保存下来，然后cat install.sh | sh -s -- -b /usr/local/bin latest</span><br><span class="line">如果还是有网络问题，立即换到网络通畅的机器上，这个反正是静态工具，不依赖集群的。</span><br><span class="line"></span><br><span class="line"># usage:</span><br><span class="line">% grype yizhiren/opa:0.35.0-rootless</span><br><span class="line"></span><br><span class="line"> ✔ Vulnerability DB        [updated]</span><br><span class="line"> ✔ Loaded image            </span><br><span class="line"> ✔ Parsed image            </span><br><span class="line"> ✔ Cataloged packages      [101 packages]</span><br><span class="line"> ✔ Scanned image           [21 vulnerabilities]</span><br><span class="line"></span><br><span class="line">NAME              INSTALLED              FIXED-IN  VULNERABILITY     SEVERITY   </span><br><span class="line">coreutils         8.32-4ubuntu2                    CVE-2016-2781     Low         </span><br><span class="line">libc-bin          2.34-0ubuntu3                    CVE-2016-10228    Negligible  </span><br><span class="line">libc-bin          2.34-0ubuntu3                    CVE-2021-38604    Medium      </span><br><span class="line">libc-bin          2.34-0ubuntu3                    CVE-2020-29562    Low         </span><br><span class="line">libc-bin          2.34-0ubuntu3                    CVE-2019-25013    Low         </span><br><span class="line">libc6             2.34-0ubuntu3                    CVE-2016-10228    Negligible  </span><br><span class="line">libc6             2.34-0ubuntu3                    CVE-2021-38604    Medium</span><br><span class="line">......</span><br></pre></td></tr></table></figure>



<h2 id="sysdig-falco"><a href="#sysdig-falco" class="headerlink" title="sysdig&#x2F;falco"></a>sysdig&#x2F;falco</h2><p>falco会安装内核驱动，然后收集系统的所有行为，然后在上层通过规则来过滤关注的事件并记录日志，是个很强悍的工具。</p>
<p><img src="/linkimage/cksknowledge/falco_architecture.png" alt="rbac角色"></p>
<p>图片来自<a target="_blank" rel="noopener" href="https://falco.org/docs/getting-started/">Getting Started</a></p>
<p>安装falco有两种途径，一种是物理机直接安装，一种是通过docker安装，不过遗憾的是这个工具不支持arm。所以树莓派上跑不起来，还是得在外部机器安装一下，这个工具考试是必考的，大家一定要找个集群安装上尝试一下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">N: Skipping acquire of configured file &#x27;main/binary-arm64/Packages&#x27; as repository &#x27;https://download.falco.org/packages/deb stable InRelease&#x27; doesn&#x27;t support architecture &#x27;arm64&#x27;</span><br></pre></td></tr></table></figure>

<p>下面的步骤基于amd64的机器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"># 安装falco</span><br><span class="line"># 直接root用户下操作的，所以省略sudo命令，若非root请加上sudo</span><br><span class="line"></span><br><span class="line"># https://falco.org/docs/getting-started/installation/</span><br><span class="line"># https://falco.org/docs/getting-started/running/</span><br><span class="line"></span><br><span class="line"># 直接安装</span><br><span class="line">curl -s https://falco.org/repo/falcosecurity-3672BA8F.asc | apt-key add -</span><br><span class="line">echo &quot;deb https://download.falco.org/packages/deb stable main&quot; \ | tee -a /etc/apt/sources.list.d/falcosecurity.list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apt install linux-headers-$(uname -r)</span><br><span class="line"></span><br><span class="line">apt-get update &amp;&amp; sudo apt-get install falco -y</span><br><span class="line"></span><br><span class="line">systemctl start falco</span><br><span class="line">systemctl status falco</span><br><span class="line"></span><br><span class="line"># insert kernel module</span><br><span class="line">falco-driver-loader</span><br><span class="line"></span><br><span class="line"># check working</span><br><span class="line">curl localhost:8765/healthz; echo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 通过docker安装</span><br><span class="line"># load driver</span><br><span class="line">docker pull falcosecurity/falco-driver-loader:latest</span><br><span class="line">docker run --rm -i -t \</span><br><span class="line">    --privileged \</span><br><span class="line">    -v /root/.falco:/root/.falco \</span><br><span class="line">    -v /proc:/host/proc:ro \</span><br><span class="line">    -v /boot:/host/boot:ro \</span><br><span class="line">    -v /lib/modules:/host/lib/modules:ro \</span><br><span class="line">    -v /usr:/host/usr:ro \</span><br><span class="line">    -v /etc:/host/etc:ro \</span><br><span class="line">    falcosecurity/falco-driver-loader:latest &amp;&amp; echo &quot;Falco drivers installed!&quot;</span><br><span class="line"></span><br><span class="line"># run falco</span><br><span class="line">docker pull falcosecurity/falco-no-driver:latest</span><br><span class="line">docker run --rm -d \</span><br><span class="line">  --name &quot;falco_training&quot; \</span><br><span class="line">  --security-opt apparmor:unconfined \</span><br><span class="line">  -p 8765:8765 \</span><br><span class="line">  -e HOST_ROOT=/ \</span><br><span class="line">  --cap-add SYS_PTRACE \</span><br><span class="line">  --pid=host $(ls /dev/falco* | xargs -I &#123;&#125; echo --device &#123;&#125;) \</span><br><span class="line">  -v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">  falcosecurity/falco-no-driver:latest</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试功能：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">默认的falco就会关注一些事件并做记录，我们就来测试这些事件。</span><br><span class="line"></span><br><span class="line"># 1. 运行敏感操作，这是一个敏感操作，需要被关注。</span><br><span class="line">root@ubsvr1:~# docker run -v /root:/root busybox sh -c &quot;find /root -name id_rsa&quot;</span><br><span class="line">/root/.ssh/id_rsa</span><br><span class="line">注意这里挂载root目录是模拟真实的危险场景，不挂载也不影响本次测试。</span><br><span class="line"></span><br><span class="line"># 2. 然后查看falco的日志，看看有没有捕捉到。</span><br><span class="line"># https://falco.org/docs/getting-started/running/</span><br><span class="line"># 日志获取有两种情况，针对直接安装和docker安装分别如此查看日志：</span><br><span class="line">host安装的话：</span><br><span class="line">journalctl -u falco</span><br><span class="line">docker安装的话：</span><br><span class="line">docker logs container-name</span><br><span class="line"></span><br><span class="line">root@ubsvr1:~# docker logs falco_training 2&gt;&amp;1 | grep &quot;find /root -name id_rsa&quot;</span><br><span class="line"># 或者 journalctl -u falco | grep &quot;find /root -name id_rsa&quot;</span><br><span class="line">Jan 22 13:40:31 ubsvr1 falco[1746328]: 13:40:31.098801741: Warning Grep private keys or passwords activities found (user=root user_loginuid=-1 command=find /root -name id_rsa container_id=8b66d2dd103b container_name=&lt;NA&gt; image=&lt;NA&gt;:&lt;NA&gt;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 3. 我们来找一下这个规则是在哪里配置的</span><br><span class="line"># host方式安装的话，配置文件列表在/etc/falco/falco.yaml中配置：</span><br><span class="line">rules_file:</span><br><span class="line">	- /etc/falco/falco_rules.yaml</span><br><span class="line">	- /etc/falco/falco_fules.local.yaml</span><br><span class="line">	- /etc/falco/k8s_audit_rules.yaml</span><br><span class="line">	- /etc/falco/rules.d</span><br><span class="line">docker方式运行的话，就是容器内的这些文件。</span><br><span class="line"></span><br><span class="line"># 找到了配置</span><br><span class="line">root@ubsvr1:/etc/falco# grep &quot;Grep private keys or passwords activities found&quot; . -r</span><br><span class="line">./falco_rules.yaml:    Grep private keys or passwords activities found</span><br><span class="line">然后通过vi去查看文件，可以查看这条规则的详情：</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/linkimage/cksknowledge/falco_rule_match.png" alt="falco_rule_match"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">可以看到一个规则(rule)的基本结构，condition和触发条件，output是输出格式。</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">output输出到哪里，定义在/etc/falco/falco.yaml中</span><br><span class="line"></span><br><span class="line">在配置文件中alert配置类似如下：</span><br><span class="line">file_output:</span><br><span class="line">  enabled: false</span><br><span class="line">  keep_alive: false</span><br><span class="line">  filename: ./events.txt</span><br><span class="line"></span><br><span class="line">stdout_output:</span><br><span class="line">  enabled: true</span><br><span class="line"></span><br><span class="line">program_output:</span><br><span class="line">  enabled: false</span><br><span class="line">  keep_alive: false</span><br><span class="line">  program: &quot;jq &#x27;&#123;text: .output&#125;&#x27; | curl -d @- -X POST https://hooks.slack.com/services/XXX&quot;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最后最主要的falco的规则部分，需要经过简单的学习：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">参考文档，至少要学会配置一个最基本的rule。</span><br><span class="line">https://falco.org/docs/examples/</span><br><span class="line">https://falco.org/docs/rules/</span><br><span class="line"></span><br><span class="line">再举一个例子参考：</span><br><span class="line"># 例子：禁止写/etc/hosts</span><br><span class="line">- rule: Detect Write Below /etc/hosts</span><br><span class="line">  desc: an attempt to write to /etc/hosts file (CVE-2020-8557)</span><br><span class="line">  condition: open_write and container and fd.name=/etc/hosts</span><br><span class="line">  output: &quot;File /etc/hosts opened for writing (user=%user.name command=%proc.cmdline parent=%proc.pname pcmdline=%proc.pcmdline file=%fd.name program=%proc.name gparent=%proc.aname[2] ggparent=%proc.aname[3] gggparent=%proc.aname[4] container_id=%container.id image=%container.image.repository)&quot;</span><br><span class="line">  priority: ERROR</span><br><span class="line">  tags: [filesystem, mitre_persistence]</span><br></pre></td></tr></table></figure>





<h2 id="sysdig"><a href="#sysdig" class="headerlink" title="sysdig"></a>sysdig</h2><p>我一直装不起来，没有成功使用过，好在最后考试也没考到他。</p>
<p>我记录一下我折腾的安装方法，你们可以不用参考我的，用你能装上的就行。我有机会会再次尝试。（TODO）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">这个东西的安装实在是太麻烦了，文档也一点都不友好，找都找不到怎么弄。</span><br><span class="line">这个sysdig是falco产品的公司，但是falco就简单很多。sysdig是整个平台。</span><br><span class="line"></span><br><span class="line">&gt; 先在这里下载installer</span><br><span class="line">https://github.com/draios/sysdigcloud-kubernetes/releases</span><br><span class="line">&gt; 然后再这里下载values.yaml</span><br><span class="line">https://github.com/draios/onprem-install-docs/blob/main/5.0.4/values.yaml</span><br><span class="line">&gt; 然后填写values.yaml中的字段</span><br><span class="line">quaypullsecret字段这么填：</span><br><span class="line">从这里拷贝pull secret：</span><br><span class="line">https://console.redhat.com/openshift/install/pull-secret</span><br><span class="line">然后 echo &lt;secret&gt; | base64 -w 0 获取base64后的值填到quaypullsecret中。</span><br><span class="line">storageClassProvisioner填写 local</span><br><span class="line">username、license填个邮箱</span><br><span class="line">dnsName填jinqidiguo.com</span><br><span class="line">字段填写都可以参考这里</span><br><span class="line">https://github.com/draios/onprem-install-docs/blob/main/5.0.4/configuration_parameters.md</span><br><span class="line"></span><br><span class="line">但是即使配置了size为small还是无法安装成功，因为从他的错误信息看，他要求整个集群至少包含CPU14个，内存21G。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">后来尝试了单机的sysdig</span><br><span class="line">https://github.com/draios/sysdig</span><br><span class="line">执行：</span><br><span class="line">sudo docker run --rm -i -t --privileged --net=host \</span><br><span class="line">    -v /var/run/docker.sock:/host/var/run/docker.sock \</span><br><span class="line">    -v /dev:/host/dev \</span><br><span class="line">    -v /proc:/host/proc:ro \</span><br><span class="line">    -v /boot:/host/boot:ro \</span><br><span class="line">    -v /src:/src \</span><br><span class="line">    -v /lib/modules:/host/lib/modules:ro \</span><br><span class="line">    -v /usr:/host/usr:ro \</span><br><span class="line">    -v /etc:/host/etc:ro \</span><br><span class="line">    docker.io/sysdig/sysdig</span><br><span class="line">注意由于mount了用户目录外的目录，所以docker得用apt安装不能用snap安装，不然会失败。</span><br><span class="line"></span><br><span class="line">但是还是运行不起来，报了GLIBC not found。</span><br><span class="line">好了不折腾了。</span><br></pre></td></tr></table></figure>



<h2 id="gadget"><a href="#gadget" class="headerlink" title="gadget"></a>gadget</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">一系列的检查集群的小部件</span><br><span class="line"># install</span><br><span class="line">  # 根据这里安装krew插件</span><br><span class="line">https://krew.sigs.k8s.io/docs/user-guide/setup/install/</span><br><span class="line">  # 然后用krew安装gadget插件</span><br><span class="line">  # https://github.com/kinvolk/inspektor-gadget/blob/main/docs/install.md#installing-kubectl-gadget</span><br><span class="line">kubectl krew install gadget</span><br><span class="line">  # 用gadget插件部署gadget的DaemonSet</span><br><span class="line">  # 这里arm的image没有所以arm集群会安装失败。</span><br><span class="line">kubectl gadget deploy | kubectl apply -f -</span><br><span class="line"></span><br><span class="line"># 然后根据文档使用这些小部件，</span><br><span class="line">https://github.com/kinvolk/inspektor-gadget#the-gadgets</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="immutable-pod-stateless-pod-1"><a href="#immutable-pod-stateless-pod-1" class="headerlink" title="immutable pod &#x2F; stateless pod"></a>immutable pod &#x2F; stateless pod</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">immutable主要是指pod不能修改主机文件</span><br><span class="line">涉及security context中的readOnlyRootFilesystem以及privileged。</span><br><span class="line"></span><br><span class="line">stateles主要是不能存状态数据在container中，emptyDir的volume也不行。</span><br></pre></td></tr></table></figure>



<h2 id="hostPath-security-issue"><a href="#hostPath-security-issue" class="headerlink" title="hostPath security issue"></a>hostPath security issue</h2><p>挂载一个hostPath的volumes的时候，需要设置挂载方式为read only， 不然存在安全风险。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">volumes:</span><br><span class="line">- name: test-volume</span><br><span class="line">  hostPath:</span><br><span class="line">    path: /data</span><br><span class="line">    type: Directory</span><br><span class="line">这时定义hostpath的volume，定义的时候没有readonly选项。</span><br><span class="line"></span><br><span class="line">volumeMounts:</span><br><span class="line">- name: test-volume</span><br><span class="line">  mountPath: /test-volume</span><br><span class="line">  readOnly: true</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在官方文档中有这么一段话</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">https://kubernetes.io/docs/concepts/storage/volumes/#hostpath</span><br><span class="line"></span><br><span class="line">Warning:</span><br><span class="line">HostPath volumes present many security risks, and it is a best practice to avoid the use of HostPaths when possible. When a HostPath volume must be used, it should be scoped to only the required file or directory, and mounted as ReadOnly.</span><br><span class="line"></span><br><span class="line">If restricting HostPath access to specific directories through AdmissionPolicy, volumeMounts MUST be required to use readOnly mounts for the policy to be effective.</span><br></pre></td></tr></table></figure>

<p>简单讲就是在强调你在挂载hostpath的volume的时候必须设置readOnly。</p>
<p>这是因为，已经证明存在一些方法来绕过约束。比如我配置了hostPath不能访问A目录，但是我可以通过挂载B目录间接访问A目录；或者我配置了hostPath只能访问A目录，但是我可以通过A目录，间接访问到B目录。是不是很神奇。</p>
<p>这部分内容比较独立，并且偏向于攻击，也没有考到，感兴趣的可以跳到<a href="https://yizhi.ren/2022/02/08/hostpath/">k8s中的hostPath的安全隐患</a>查看。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>最后祝大家考试顺利~</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://yizhi.ren/2022/02/06/dangerousprivileges/">k8s中的危险权限</a><br><a href="https://yizhi.ren/2022/01/25/setupk8s/">树莓派搭建k8s集群</a><br><a href="https://yizhi.ren/2022/02/08/hostpath/">k8s中的hostPath的安全隐患</a><br><a href="https://yizhi.ren/2022/02/07/podsecuritypolicy/">k8s中的PodSecurityPolicy</a><br><a target="_blank" rel="noopener" href="https://github.com/walidshaari/Kubernetes-Certified-Administrator">CKA prepare</a><br><a target="_blank" rel="noopener" href="https://github.com/dgkanatsios/CKAD-exercises">CKAD prepare</a><br><a target="_blank" rel="noopener" href="https://github.com/walidshaari/Certified-Kubernetes-Security-Specialist">CKS prepare</a><br><a target="_blank" rel="noopener" href="https://github.com/killer-sh/cks-challenge-series/tree/master/challenges/ImagePolicyWebhook">cks-challenge-series&#x2F;ImagePolicyWebhook</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#imagepolicywebhook">kubernetes admission-controllers imagepolicywebhook</a><br><a target="_blank" rel="noopener" href="https://itnext.io/cks-exam-series-4-crash-that-apiserver-5f4d3d503028">CKS Exam Series #4 Crash that Apiserver !</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/">kubernetes Pod Lifecycle</a><br><a target="_blank" rel="noopener" href="https://cloud.google.com/blog/products/containers-kubernetes/kubernetes-best-practices-terminating-with-grace">Kubernetes best practices: terminating with grace</a><br><a target="_blank" rel="noopener" href="https://learnk8s.io/blog/smaller-docker-images">3 simple tricks for smaller Docker images</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/containers/runtime-class/">Kubernetes Runtime Class</a><br><a target="_blank" rel="noopener" href="https://gvisor.dev/docs/user_guide/install/">gvisor Installation</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/storage/volumes/#hostpath">kubernetes volume hostpath</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/extend-kubernetes/configure-aggregation-layer/#authentication-flow">kubernetes authentication-flow</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/">kubernetes Authenticating</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tutorials/clusters/apparmor/">Kubernetes Restrict a Container’s Access to Resources with AppArmor</a><br><a target="_blank" rel="noopener" href="https://github.com/open-policy-agent/gatekeeper/blob/release-3.7/deploy/gatekeeper.yaml">GateKeeperV3 deploy file</a><br><a target="_blank" rel="noopener" href="https://www.openpolicyagent.org/docs/latest/kubernetes-tutorial/">OPA Tutorial</a><br><a target="_blank" rel="noopener" href="https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions">Securing Kubernetes Clusters by Eliminating Risky Permissions</a><br><a target="_blank" rel="noopener" href="https://dominik-tornow.medium.com/inside-kubernetes-rbac-9988b08a738a">Inside Kubernetes RBAC</a><br><a target="_blank" rel="noopener" href="https://rbac.dev/">advocacy site for Kubernetes RBAC</a><br><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG">kubernetes changelog</a><br><a target="_blank" rel="noopener" href="https://github.com/kubernetes/dashboard/blob/36e967d848006dee386355c26f392f9045bc8f3d/docs/common/dashboard-arguments.md">kubernetes Dashboard arguments</a><br><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/kubernetes/dashboard/v2.4.0/aio/deploy/recommended.yaml">Dashboard deploy file</a><br><a target="_blank" rel="noopener" href="https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md">Dashboard Creating sample user</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/#deploying-the-dashboard-ui">kubernetes Deploying the Dashboard UI</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/extend-kubernetes/configure-aggregation-layer/">kubernetes Configure the Aggregation Layer</a><br><a target="_blank" rel="noopener" href="https://itnext.io/our-journey-in-building-a-kubernetes-aggregated-api-server-29a4f9c1de22">Building Kubernetes Aggregated API Server</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/tls/managing-tls-in-a-cluster/">kubernetes Manage TLS Certificates in a Cluster</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/configuration/secret/#tls-secrets">kubernetes TLS secrets</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/ingress/#tls">kubernetes TLS ingress</a><br><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/aks/ingress-own-tls?tabs=azure-cli">Create an HTTPS ingress controller and use your own TLS certificates on Azure Kubernetes Service</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/access-authn-authz/certificate-signing-requests/#signers">kubernetes Signers</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/access-authn-authz/certificate-signing-requests/#normal-user">kubernetes Normal user</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/security/pod-security-admission/">kubernetes Pod Security Admission</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tutorials/clusters/seccomp/">kubernetes Restrict a Container’s Syscalls with seccomp</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/command-line-tools-reference/feature-gates/">kubernetes Feature Gates</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/blog/2021/08/25/seccomp-default/">kubernetes Enable seccomp for all workloads with a new v1.22 alpha feature</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server">kubernetes Use the Default Service Account to access the API server</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#pod-garbage-collection">kubernetes Garbage collection of failed Pods</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/">kube-apiserver command line parameter</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/">kubernetes Encrypting Secret Data at Rest</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/debug-application-cluster/audit/">kubernetes Auditing</a><br><a target="_blank" rel="noopener" href="https://trstringer.com/kubernetes-alwayspullimages/">Kubernetes’ AlwaysPullImages Admission Control - the Importance, Implementation, and Security Vulnerability in its Absence</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#alwayspullimages">kubernetes AlwaysPullImages</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/pull-image-private-registry/">kubernetes imagePullSecrets</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#eventratelimit">kubernetes admission-control eventratelimit</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/#anonymous-requests">kubernetes Anonymous requests</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/">kubernetes Kubelet Configuration (v1beta)</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/access-authn-authz/webhook/">kubernetes Webhook Mode</a><br><a target="_blank" rel="noopener" href="https://downloads.cisecurity.org/">CIS下载网站</a><br><a target="_blank" rel="noopener" href="https://www.ibm.com/docs/zh/cloud-private/3.1.2?topic=upgrade-kubelet-container-fails-start">Kubelet 无法启动</a><br><a target="_blank" rel="noopener" href="https://github.com/aquasecurity/kube-bench/blob/main/docs/running.md">Running kube-bench</a><br><a target="_blank" rel="noopener" href="https://github.com/aquasecurity/kube-bench/blob/main/docs/installation.md">kube-bench Installation</a><br><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml">metrics server deploy file</a><br><a target="_blank" rel="noopener" href="https://github.com/kubernetes/ingress-nginx/blob/main/deploy/static/provider/baremetal/deploy.yaml">ingress-nginx deploy file</a><br><a target="_blank" rel="noopener" href="https://github.com/kubernetes/ingress-gce">github ingress-gce repo</a><br><a target="_blank" rel="noopener" href="https://github.com/kubernetes/ingress-nginx">github ingress-nginx repo</a><br><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/issues/51076#issuecomment-412846482">anonymous-auth discuss in github kubernetes</a><br><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubeadm/issues/798#issuecomment-470579937">anonymous-auth discuss in github kubeadm</a><br><a target="_blank" rel="noopener" href="https://github.com/kinvolk/inspektor-gadget#the-gadgets">gadgets list</a><br><a target="_blank" rel="noopener" href="https://github.com/kinvolk/inspektor-gadget/blob/main/docs/install.md#installing-kubectl-gadget">installing-kubectl-gadget</a><br><a target="_blank" rel="noopener" href="https://krew.sigs.k8s.io/docs/user-guide/setup/install/">krew installing</a><br><a target="_blank" rel="noopener" href="https://github.com/draios/sysdig">sysdig github</a><br><a target="_blank" rel="noopener" href="https://github.com/draios/onprem-install-docs/blob/main/5.0.4/configuration_parameters.md">Sysdig Onprem Configuration Parameters</a><br><a target="_blank" rel="noopener" href="https://github.com/draios/sysdigcloud-kubernetes/releases">sysdigcloud releases</a><br><a target="_blank" rel="noopener" href="https://github.com/draios/onprem-install-docs/blob/main/5.0.4/values.yaml">Sysdig Onprem Configuration Values</a><br><a target="_blank" rel="noopener" href="https://falco.org/docs/rules/">Falco Rules</a><br><a target="_blank" rel="noopener" href="https://falco.org/docs/examples/">Falco Examples</a><br><a target="_blank" rel="noopener" href="https://falco.org/docs/getting-started/running/">Falco Running</a><br><a target="_blank" rel="noopener" href="https://falco.org/docs/getting-started/installation/">Falco Install</a><br><a target="_blank" rel="noopener" href="https://github.com/anchore/grype">anchore&#x2F;grype</a><br><a target="_blank" rel="noopener" href="https://github.com/anchore/syft">anchore&#x2F;syft</a><br><a target="_blank" rel="noopener" href="https://github.com/aquasecurity/trivy">aquasecurity&#x2F;trivy</a><br><a target="_blank" rel="noopener" href="https://aquasecurity.github.io/trivy/v0.22.0/getting-started/installation/">trivy installation</a><br><a target="_blank" rel="noopener" href="https://github.com/controlplaneio/kubesec">controlplaneio&#x2F;kubesec</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/338036211">一文看懂 Container Runtime</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/payimage/wechat.png" alt="yizhiren 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/payimage/zhifubao.png" alt="yizhiren 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/kubernetes/" rel="tag"># kubernetes</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/02/08/hostpath/" rel="prev" title="k8s中的hostPath的安全隐患">
                  <i class="fa fa-angle-left"></i> k8s中的hostPath的安全隐患
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/06/15/namespace/" rel="next" title="linux namespace">
                  linux namespace <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">浙ICP备14030596号-5 </a>
      <img src="https://beian.mps.gov.cn/web/assets/logo01.6189a29f.png" alt=""><a href="https://beian.mps.gov.cn/#/query/webSearch?code=33011002016624" rel="noopener" target="_blank">浙公网安备 33011002016624号 </a>
  </div>
  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-user"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">yizhiren</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"yizhiren","repo":"yizhiren.github.io","client_id":"f06437e321af81a44e6e","client_secret":"fc63095ff123d820c599d51aaf2030b542bf8854","admin_user":"yizhiren","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":null,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"bc9c229c312c8410d843df392c0ce55a"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
